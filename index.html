<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCS Updates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script>
        // Set up dark mode based on localStorage or system preference (Prevents FOUC)
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Adjusted timeline-dot ring color for better contrast */
        .timeline-dot {
            box-shadow: 0 0 0 4px #f9fafb; 
        }
        @media (prefers-color-scheme: dark) {
            .timeline-dot { box-shadow: 0 0 0 4px #030712; }
        }
        .converter-input {
            appearance: textfield; 
        }
        .converter-input::-webkit-outer-spin-button,
        .converter-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Keyframes for flash effect on empty post click */
        @keyframes flash-red {
            0%, 100% { border-color: rgb(229 231 235); }
            50% { border-color: rgb(239 68 68); }
        }
        .flash-red {
            animation: flash-red 0.5s ease-in-out;
        }
        .tag-pill.selected {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-color: #2563eb;
        }
        .dark .tag-pill.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background-color: #334155;
        }
        
        /* Restored: Timeline Structure Enhancement */
        #posts-feed {
            /* Add a persistent left border to the whole feed container */
            border-left: 1px solid #e5e7eb; /* gray-200 */
        }
        .dark #posts-feed {
             border-left: 1px solid #1f2937; /* gray-800 */
        }
        .post-container {
            /* Reset the left border on individual posts */
            border-left: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 min-h-screen transition-colors">

    <div id="app" class="max-w-7xl mx-auto px-4 py-6">
        
        <header class="flex flex-col lg:flex-row items-center justify-between gap-6 mb-8">
            <div class="flex items-center gap-4 w-full lg:w-auto justify-between lg:justify-start">
                <h1 class="text-2xl font-bold tracking-tight whitespace-nowrap">PCS Updates</h1>
                
                <div class="flex lg:hidden items-center gap-2">
                    <button id="dark-mode-toggle-mobile" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:inline"></i>
                    </button>
                    <button id="login-btn-mobile" class="px-3 py-1 bg-gray-200 dark:bg-gray-800 rounded-full text-xs hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">Admin</button>
                </div>
            </div>

            <div class="w-full lg:max-w-xl relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="Search timeline updates..." 
                    class="w-full py-2.5 pl-10 pr-4 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm">
            </div>
            
            <div class="hidden lg:flex items-center gap-3">
                <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors" title="Toggle Dark/Light Mode">
                    <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:inline"></i>
                </button>
                
                <div id="admin-status" class="text-xs font-medium text-red-500 hidden"></div>
                <button id="login-btn" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-800 rounded-full text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">Admin Login</button>
                
                <div id="user-status" class="h-9 w-9 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800 text-gray-500 dark:text-gray-400" title="Anonymous User">
                     <i data-lucide="user" class="w-5 h-5"></i>
                </div>
            </div>
        </header>

        <div id="nav-tabs" class="flex border-b border-gray-200 dark:border-gray-800 mb-6">
            <button data-view="timeline" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400">Timeline</button>
            <button data-view="tools" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Tools</button>
            <button data-view="pcstools" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">PCS Tools</button>
            <button data-view="tsc-helper" id="tsc-helper-tab" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">TSC Helper</button>
        </div>

        <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h2 class="text-xl font-bold mb-4">Admin Login</h2>
                <input id="admin-user" type="text" placeholder="Username (admin)" class="w-full p-2 mb-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="admin">
                <input id="admin-pass" type="password" placeholder="Password (admin)" class="w-full p-2 mb-4 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="admin">
                <div class="flex justify-end gap-3">
                    <button id="close-modal-btn" class="px-4 py-2 text-sm rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                    <button id="submit-login-btn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Login</button>
                </div>
            </div>
        </div>
        
        <div id="success-container" class="hidden fixed top-4 right-4 z-50 max-w-sm bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-200 p-4 rounded-lg border border-green-200 dark:border-green-800 text-sm flex items-start gap-3 shadow-lg">
            <i data-lucide="check-circle" class="w-5 h-5 mt-0.5"></i>
            <span id="success-message">Update successful!</span>
            <button onclick="document.getElementById('success-container').classList.add('hidden')" class="ml-auto text-green-500 hover:text-green-700">&times;</button>
        </div>

        <div id="error-container" class="hidden fixed top-4 right-4 z-50 max-w-sm bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200 p-4 rounded-lg border border-red-200 dark:border-red-800 text-sm flex items-start gap-3 shadow-lg">
            <i data-lucide="alert-triangle" class="w-5 h-5 mt-0.5"></i>
            <span id="error-message"></span>
            <button onclick="document.getElementById('error-container').classList.add('hidden')" class="ml-auto text-red-500 hover:text-red-700">&times;</button>
        </div>

        <div id="timeline-view" class="view">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                
                <div class="lg:col-span-4 lg:sticky lg:top-4 space-y-4">
                    <div id="composer-card" class="bg-white dark:bg-gray-900 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800 p-5 transition-all duration-300">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                            What's new?
                        </h2>

                        <input id="post-title" type="text" placeholder="Title (Optional)" 
                            class="w-full bg-transparent border-b border-gray-200 dark:border-gray-700 focus:border-blue-500 focus:ring-0 text-base font-semibold placeholder-gray-400 mb-3 pb-1 outline-none transition-colors">

                        <textarea id="post-content" placeholder="Type your update here..." 
                            class="w-full min-h-[120px] resize-none bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-transparent focus:bg-white dark:focus:bg-gray-900 focus:border-blue-500 focus:ring-0 text-sm placeholder-gray-400 mb-4 outline-none transition-all"></textarea>
                        
                        <div class="mb-4">
                            <div id="tag-selector" class="flex flex-wrap gap-2">
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="General">General</button>
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="Feature">Feature</button>
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="Bug">Bug</button>
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="Announcement">Announcement</button>
                            </div>
                        </div>

                        <div id="meta-input-container" class="space-y-3">
                            <div id="link-input-container" class="flex items-center gap-2 bg-gray-50 dark:bg-gray-800/50 px-3 py-2 rounded-lg border border-gray-100 dark:border-gray-800">
                                <i data-lucide="image" class="w-4 h-4 text-gray-400"></i>
                                <input type="url" id="link-url" placeholder="Optional Image/Link URL" 
                                    class="flex-1 bg-transparent border-0 focus:outline-none text-xs">
                                <button id="clear-link-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                            </div>

                            <button id="submit-btn" class="w-full flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all shadow-md shadow-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                                <span>Post Update</span>
                                <i data-lucide="send" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-400 px-2 text-center">
                        <p>Formatting Tip: Use standard text. URLs in the link field render as previews.</p>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div id="posts-feed" class="space-y-6 relative pb-12">
                        <div class="text-center py-20 text-gray-400 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-200 dark:border-gray-800">
                            <i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2 opacity-50"></i>
                            <span class="text-sm">Loading updates...</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="tools-view" class="view hidden max-w-3xl mx-auto">
            <h2 class="text-xl font-bold mb-6">Utility Tools</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
                    <h3 class="text-sm font-semibold mb-4 flex items-center gap-2 uppercase text-gray-500 tracking-wider">
                        <i data-lucide="clock" class="w-4 h-4 text-blue-500"></i>
                        Decimal Time
                    </h3>
                    <div class="flex gap-4 mb-4">
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">HOURS</label>
                            <input type="number" id="hours-input" min="0" max="23" placeholder="HH" value="8"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">MINUTES</label>
                            <input type="number" id="minutes-input" min="0" max="59" placeholder="MM" value="30"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
                        <p class="text-xs text-gray-400 mb-1">RESULT</p>
                        <p id="decimal-result" class="text-3xl font-bold text-blue-600 dark:text-blue-400">8.50</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
                    <h3 class="text-sm font-semibold mb-4 flex items-center gap-2 uppercase text-gray-500 tracking-wider">
                        <i data-lucide="percent" class="w-4 h-4 text-green-500"></i>
                        Percentage
                    </h3>
                    <div class="flex gap-2 mb-4 items-end">
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">VALUE</label>
                            <input type="number" id="percent-x" value="15"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                        <span class="text-sm text-gray-400 pb-3">% of</span>
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">TOTAL</label>
                            <input type="number" id="percent-y" value="200"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
                        <p class="text-xs text-gray-400 mb-1">RESULT</p>
                        <p id="percentage-result" class="text-3xl font-bold text-green-600 dark:text-green-400">30</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="pcstools-view" class="view hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                <div id="tools-admin-panel" class="lg:col-span-1 space-y-4 hidden lg:sticky lg:top-4">
                    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800 p-5">
                        <h3 class="text-lg font-bold mb-4">Manage Tools</h3>
                        <input type="text" id="tool-title-input" placeholder="Tool Title" class="w-full p-2 mb-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm">
                        <textarea id="tool-description-input" placeholder="Tool Description" class="w-full p-2 mb-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm h-20 resize-none"></textarea>
                        <input type="url" id="tool-link-input" placeholder="Download Link (URL)" class="w-full p-2 mb-4 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm">
                        <button id="add-tool-btn" class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm">Add New Tool</button>
                    </div>
                    <div id="managed-tools-list" class="space-y-3 p-4 bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800">
                        </div>
                </div>

                <div class="lg:col-span-2">
                    <h2 class="text-xl font-bold mb-6">Downloadable PCS Tools</h2>
                    <div id="tools-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p id="tools-loading-message" class="col-span-full text-center text-gray-400 py-10">Loading tools...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tsc-helper-view" class="view hidden max-w-3xl mx-auto">
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800 p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="sheets-and-tables" class="w-5 h-5 text-green-600"></i>
                    TSC Helper: Time Segment Sync
                </h2>

                <div id="google-auth-status" class="bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200 p-3 rounded-lg border border-red-200 dark:border-red-800 text-sm mb-4 flex items-center justify-between">
                    <span>Sheet access not granted.</span>
                    <button id="google-auth-button" class="px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700 transition-colors">Authorize Access</button>
                </div>
                
                <div id="sync-form-content" class="space-y-4">
                    <div>
                        <label for="tech-id-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tech ID</label>
                        <input type="text" id="tech-id-input" placeholder="Enter your Tech ID" 
                            class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm">
                    </div>
                    <div>
                        <label for="time-segment-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time Segments (Paste one per line)</label>
                        <textarea id="time-segment-input" placeholder="Example:&#10;2:30 PM - 3:00 PM - Lunch&#10;3:00 PM - 5:00 PM - Task description" 
                            class="w-full min-h-[150px] resize-none p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm font-mono"></textarea>
                    </div>
                    <button id="sync-to-sheet-btn" class="w-full flex items-center justify-center gap-2 px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        <span>Sync to Sheet</span>
                    </button>
                </div>
            </div>
            <div class="text-xs text-gray-400 px-2 mt-4">
                <p>Note: Syncing data will use your authenticated Google email and append new rows to the configured spreadsheet.</p>
            </div>
        </div>


    </div>

    <button id="scroll-to-top" class="fixed bottom-4 right-4 p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-opacity duration-300 opacity-0 pointer-events-none z-40">
        <i data-lucide="arrow-up" class="w-5 h-5"></i>
    </button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, setDoc, updateDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

        // --- CONFIGURATION START ---
        const firebaseConfig = {
            apiKey: "AIzaSyBBcrvThge1YHswamX_pb7KghiCm5ROUH8",
            authDomain: "pcs-updates.firebaseapp.com",
            projectId: "pcs-updates",
            storageBucket: "pcs-updates.firebasestorage.app",
            messagingSenderId: "424424316130",
            appId: "1:424424316130:web:84f63aab43b4687b08d2bb"
        };
        
        // NEW: GOOGLE SHEETS CONFIGURATION
        const googleConfig = {
            API_KEY: "AIzaSyBxlhWwf3mlS_6Q3BiUsfpH21AsbhVmDw8",
            CLIENT_ID: "221107133299-7r4vnbhpsdrnqo8tss0dqbtrr9ou683e.apps.googleusercontent.com",
            // CRITICAL FIX: Add both Sheets scope and basic user email scope
            SCOPES: "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email",
            SPREADSHEET_ID: "1l4utLq6FR4Wnyxe_UMJG6KseiBrUVXJKalyinZDt420",
        };
        // --- CONFIGURATION END ---
        
        // --- ADMIN CONFIG (HARDCODED) ---
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin'; 

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = 'posts';

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let isAdmin = false;
        let posts = [];
        let tools = []; 
        let filteredPosts = [];
        let editingPostId = null;
        let editingToolId = null; 
        let currentView = 'timeline';
        let selectedTag = 'General';
        
        // NEW: Google Sheets Auth State
        let googleAuth = null;
        let gapiInited = false;
        let gisInited = false;
        let gapiLoaded = false;
        let googleUserEmail = null;


        // --- DOM ELEMENTS ---
        const userStatus = document.getElementById('user-status');
        const feedContainer = document.getElementById('posts-feed');
        const submitBtn = document.getElementById('submit-btn');
        const composerCard = document.getElementById('composer-card');
        const titleInput = document.getElementById('post-title');
        const contentInput = document.getElementById('post-content');
        const linkInput = document.getElementById('link-url');
        const tagSelector = document.getElementById('tag-selector');
        const tagPills = document.querySelectorAll('.tag-pill');
        const clearLinkBtn = document.getElementById('clear-link-btn');
        const searchInput = document.getElementById('search-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeToggleMobile = document.getElementById('dark-mode-toggle-mobile');
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        
        // Modal/Admin elements
        const loginBtn = document.getElementById('login-btn');
        const loginBtnMobile = document.getElementById('login-btn-mobile');
        const loginModal = document.getElementById('login-modal');
        const submitLoginBtn = document.getElementById('submit-login-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const adminUser = document.getElementById('admin-user');
        const adminPass = document.getElementById('admin-pass');
        const adminStatus = document.getElementById('admin-status');

        const timelineView = document.getElementById('timeline-view');
        const toolsView = document.getElementById('tools-view');
        const pcstoolsView = document.getElementById('pcstools-view'); 
        const tscHelperView = document.getElementById('tsc-helper-view'); // NEW
        const navTabs = document.querySelectorAll('.tab-btn');
        
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const successContainer = document.getElementById('success-container'); 
        const successMessage = document.getElementById('success-message');     

        // Tool inputs
        const hoursInput = document.getElementById('hours-input');
        const minutesInput = document.getElementById('minutes-input');
        const decimalResult = document.getElementById('decimal-result');
        const percentX = document.getElementById('percent-x');
        const percentY = document.getElementById('percent-y');
        const percentageResult = document.getElementById('percentage-result');
        
        // PCS Tools Admin Elements
        const toolsAdminPanel = document.getElementById('tools-admin-panel');
        const toolsListContainer = document.getElementById('tools-list-container');
        const toolsLoadingMessage = document.getElementById('tools-loading-message');
        const managedToolsList = document.getElementById('managed-tools-list');
        const toolTitleInput = document.getElementById('tool-title-input');
        const toolDescriptionInput = document.getElementById('tool-description-input');
        const toolLinkInput = document.getElementById('tool-link-input');
        const addToolBtn = document.getElementById('add-tool-btn');
        
        // NEW: TSC Helper Elements
        const googleAuthStatus = document.getElementById('google-auth-status');
        const googleAuthButton = document.getElementById('google-auth-button');
        const techIdInput = document.getElementById('tech-id-input');
        const timeSegmentInput = document.getElementById('time-segment-input');
        const syncToSheetBtn = document.getElementById('sync-to-sheet-btn');


        // --- GOOGLE API INITIALIZATION ---
        
        window.gapiLoaded = () => {
            gapiInited = true;
            gapi.client.init({ apiKey: googleConfig.API_KEY, discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] })
                .then(() => {
                    gapiLoaded = true;
                    console.log("GAPI client loaded.");
                    updateTscHelperUI();
                });
        }
        
        window.gisLoaded = () => {
            gisInited = true;
            googleAuth = google.accounts.oauth2.initCodeClient({
                client_id: googleConfig.CLIENT_ID,
                scope: googleConfig.SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                        handleError('Google Auth Failed: ' + tokenResponse.error);
                        return;
                    }
                    gapi.client.setToken({ access_token: tokenResponse.access_token });
                    loadUserInfoAndToggleSheetStatus();
                },
            });
            console.log("GIS client loaded.");
            updateTscHelperUI();
        }

        // Load the GIS client library for authorization
        function loadGis() {
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = window.gisLoaded;
            document.head.appendChild(script);
        }

        // Call both GAPI and GIS initialization (ensure gapi is loaded first)
        loadGis();


        // --- AUTH & INITIALIZATION ---

        signInAnonymously(auth).catch((e) => {
             console.error("Auth failed", e);
             handleError("Authentication failed.");
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Updated User UI in Header
                userStatus.className = "h-9 w-9 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-400 font-bold border border-blue-200 dark:border-blue-800";
                userStatus.innerHTML = '<i data-lucide="user-check" class="w-5 h-5"></i>';
                userStatus.title = `Connected as Member`;
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Post Update</span><i data-lucide="send" class="w-3.5 h-3.5"></i>';

                initRealtimeListener();
                initToolsListener(); 
            } else {
                currentUser = null;
                userStatus.className = "h-9 w-9 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800 text-gray-400 animate-pulse";
                userStatus.innerHTML = '<i data-lucide="user" class="w-5 h-5"></i>';
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span>Waiting for Auth...</span><i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i>';
            }
            lucide.createIcons();
            updateAdminUI();
            updateTscHelperUI(); // NEW
        });

        // --- GOOGLE SHEETS AUTH/SYNC LOGIC ---
        
        async function loadUserInfoAndToggleSheetStatus() {
            try {
                const response = await gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v2/userinfo',
                    method: 'GET'
                });
                googleUserEmail = response.result.email;
                googleAuthStatus.classList.remove('bg-red-50', 'dark:bg-red-900/20', 'border-red-200', 'dark:border-red-800');
                googleAuthStatus.classList.add('bg-green-50', 'dark:bg-green-900/20', 'border-green-200', 'dark:border-green-800');
                googleAuthStatus.innerHTML = `
                    <span>Sheet access granted for: <strong>${googleUserEmail}</strong></span>
                    <button id="google-auth-button" class="px-3 py-1 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg text-xs hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">Sign Out</button>
                `;
                syncToSheetBtn.disabled = false;
                handleSuccess("Google Sheets access granted.");
            } catch (error) {
                console.error("Error loading user info:", error);
                toggleSheetStatus(false);
                handleError("Failed to load user email. Please try authorizing again.");
            }
            lucide.createIcons();
        }
        
        function toggleSheetStatus(isAuthorized) {
            googleUserEmail = null;
            if (isAuthorized) {
                // This is now handled by loadUserInfoAndToggleSheetStatus after successful auth
            } else {
                googleAuthStatus.classList.remove('bg-green-50', 'dark:bg-green-900/20', 'border-green-200', 'dark:border-green-800');
                googleAuthStatus.classList.add('bg-red-50', 'dark:bg-red-900/20', 'border-red-200', 'dark:border-red-800');
                googleAuthStatus.innerHTML = `
                    <span>Sheet access not granted.</span>
                    <button id="google-auth-button" class="px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700 transition-colors">Authorize Access</button>
                `;
                syncToSheetBtn.disabled = true;
            }
            lucide.createIcons();
        }

        function updateTscHelperUI() {
            if (currentView === 'tsc-helper') {
                // Initial check and setup for the TSC Helper view
                if (!gapiLoaded || !gisInited) {
                    googleAuthStatus.innerHTML = `<span>Loading Google API components...</span>`;
                    syncToSheetBtn.disabled = true;
                    return;
                }
                
                // If gapi and gis are ready, check current token/email status
                if (!googleUserEmail) {
                    toggleSheetStatus(false); // Display "Authorize Access"
                } else {
                    // Re-render authorized state if email is known
                    loadUserInfoAndToggleSheetStatus();
                }
            }
        }
        
        async function writeToSheet() {
            if (!googleUserEmail) {
                return handleError("Please authorize Google Sheets access first.");
            }
            
            const techId = techIdInput.value.trim();
            const segmentData = timeSegmentInput.value.trim();

            if (!techId) return handleError("Tech ID is required.");
            if (!segmentData) return handleError("Time Segments cannot be empty.");
            
            syncToSheetBtn.disabled = true;
            syncToSheetBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Syncing...</span>';
            lucide.createIcons();

            try {
                const now = new Date().toLocaleString();
                const segments = segmentData.split('\n').filter(line => line.trim() !== '');

                const values = segments.map(segment => {
                    // Each row in the sheet: [Timestamp, Tech ID, User Email, Segment Text]
                    return [now, techId, googleUserEmail, segment.trim()];
                });
                
                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: googleConfig.SPREADSHEET_ID,
                    // NOTE: This assumes the target sheet is the first one, or you need to specify a sheet name (e.g., 'Sheet1!A:D')
                    range: 'A1', 
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: values,
                    },
                });

                if (response.result.updates.updatedRows > 0) {
                    handleSuccess(`${response.result.updates.updatedRows} time segments synced successfully!`);
                    timeSegmentInput.value = ''; // Clear input on success
                } else {
                    handleError("Sync failed: No rows were updated.");
                }

            } catch (error) {
                console.error("Sheets API Error:", error);
                if (error.result && error.result.error && error.result.error.message) {
                    handleError(`Sheets API Error: ${error.result.error.message}`);
                } else {
                    handleError("An unexpected error occurred during sync. Check console for details.");
                }
            } finally {
                syncToSheetBtn.disabled = false;
                syncToSheetBtn.innerHTML = '<i data-lucide="upload-cloud" class="w-4 h-4"></i><span>Sync to Sheet</span>';
                lucide.createIcons();
            }
        }
        
        googleAuthButton.addEventListener('click', () => {
            if (googleUserEmail) {
                // Sign out logic (clearing local token/state)
                gapi.client.setToken(null);
                toggleSheetStatus(false);
                handleSuccess("Google Sheets access revoked.");
            } else {
                // Authorize logic
                if (googleAuth) {
                    googleAuth.requestCode();
                } else {
                    handleError("Google Auth client not initialized.");
                }
            }
        });

        syncToSheetBtn.addEventListener('click', writeToSheet);


        // --- UI/VIEW MANAGEMENT ---

        function switchView(viewName) {
            currentView = viewName;
            [timelineView, toolsView, pcstoolsView, tscHelperView].forEach(view => { // NEW VIEW
                view.classList.toggle('hidden', view.id !== `${viewName}-view`);
            });
            navTabs.forEach(tab => {
                const isActive = tab.dataset.view === viewName;
                tab.classList.toggle('border-blue-600', isActive);
                tab.classList.toggle('text-blue-600', isActive);
                tab.classList.toggle('dark:text-blue-400', isActive);
                tab.classList.toggle('border-transparent', !isActive);
                tab.classList.toggle('text-gray-500', !isActive);
            });
            
            if (viewName === 'pcstools') {
                updateToolsAdminPanel(); 
            }
            
            if (viewName === 'tsc-helper') { // NEW VIEW INIT
                updateTscHelperUI();
            }
            
            lucide.createIcons();
        }

        navTabs.forEach(tab => {
            tab.addEventListener('click', () => switchView(tab.dataset.view));
        });

        // --- TAG SELECTION LOGIC ---
        
        updateTagSelection(selectedTag);

        tagPills.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedTag = btn.dataset.tag;
                updateTagSelection(selectedTag);
            });
        });

        function updateTagSelection(tag) {
            tagPills.forEach(btn => {
                if (btn.dataset.tag === tag) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        // --- ADMIN LOGIN LOGIC ---

        function updateAdminUI() {
            if (isAdmin) {
                adminStatus.textContent = 'ADMIN';
                adminStatus.classList.remove('hidden');
                loginBtn.textContent = 'Logout';
                loginBtnMobile.textContent = 'Logout';
                
                const logoutHandler = () => handleLogout();
                loginBtn.onclick = logoutHandler;
                loginBtnMobile.onclick = logoutHandler;
            } else {
                adminStatus.textContent = '';
                adminStatus.classList.add('hidden');
                loginBtn.textContent = 'Admin Login';
                loginBtnMobile.textContent = 'Admin';
                
                const loginHandler = () => loginModal.classList.remove('hidden');
                loginBtn.onclick = loginHandler;
                loginBtnMobile.onclick = loginHandler;
            }
            
            if (currentView === 'pcstools') {
                updateToolsAdminPanel();
            }
            applySearchFilter();
        }
        
        function updateToolsAdminPanel() {
            if (currentView === 'pcstools') {
                toolsAdminPanel.classList.toggle('hidden', !isAdmin);
                renderManagedTools();
            }
        }
        
        function handleLogin() {
            if (adminUser.value === ADMIN_USERNAME && adminPass.value === ADMIN_PASSWORD) {
                isAdmin = true;
                loginModal.classList.add('hidden');
                updateAdminUI();
                handleSuccess("Admin login successful."); 
            } else {
                handleError("Invalid credentials.");
            }
        }

        function handleLogout() {
            isAdmin = false;
            adminUser.value = ADMIN_USERNAME;
            adminPass.value = ADMIN_PASSWORD;
            updateAdminUI();
            handleSuccess("Logged out of Admin account."); 
        }

        submitLoginBtn.addEventListener('click', handleLogin);
        closeModalBtn.addEventListener('click', () => {
             adminUser.value = ADMIN_USERNAME; // Reset to default
             adminPass.value = ADMIN_PASSWORD; // Reset to default
             loginModal.classList.add('hidden');
        });

        // --- FIRESTORE DATA ---

        function initRealtimeListener() {
            if (!currentUser) return;
            
            onSnapshot(collection(db, COLLECTION_NAME), (snapshot) => {
                posts = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    reactions: doc.data().reactions || {} 
                }));
                posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                applySearchFilter();
            }, (error) => {
                console.error(error);
                if(error.code === 'permission-denied') handleError("Permission denied loading posts.");
            });
        }
        
        function initToolsListener() {
            onSnapshot(collection(db, 'tools'), (snapshot) => {
                tools = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data()
                }));
                tools.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderTools();
                if (isAdmin) renderManagedTools();
            }, (error) => {
                console.error("Tools listener failed", error);
                // Inform user about security rules if permission is denied
                if(error.code === 'permission-denied') handleError("Tools listener failed: Missing or insufficient permissions. Check Firestore Security Rules for the 'tools' collection.");
                else handleError("Failed to load tools.");
            });
        }

        // --- SEARCH FUNCTIONALITY ---
        searchInput.addEventListener('input', applySearchFilter);

        function applySearchFilter() {
            const query = searchInput.value.toLowerCase().trim();
            
            if (query === '') {
                filteredPosts = posts;
            } else {
                filteredPosts = posts.filter(post => 
                    (post.title && post.title.toLowerCase().includes(query)) ||
                    post.content.toLowerCase().includes(query) || 
                    (post.tag && post.tag.toLowerCase().includes(query))
                );
            }
            renderPosts(filteredPosts);
        }

        // --- POST RENDERING & CRUD ---

        function isImageUrl(url) {
            return (url || '').match(/\.(jpeg|jpg|gif|png|webp|svg)$/i) !== null;
        }

        function renderPosts(currentPosts) {
            // ... (rest of renderPosts logic remains the same)
            if (currentPosts.length === 0) {
                const message = searchInput.value.trim() ? "No results found." : "No updates yet.";
                feedContainer.innerHTML = `
                    <div class="text-center py-20 text-gray-400 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-200 dark:border-gray-800">
                        <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-4 opacity-50"></i>
                        <p>${message}</p>
                    </div>`;
                lucide.createIcons();
                return;
            }
            
            const currentUserId = currentUser ? currentUser.uid : 'temp-anon-user';

            feedContainer.innerHTML = currentPosts.map(post => {
                const isCurrentEditing = editingPostId === post.id;
                const postReactions = post.reactions;
                const reactionCount = Object.keys(postReactions).length;
                const hasReacted = currentUserId !== 'temp-anon-user' && postReactions[currentUserId];
                
                const isAuthor = post.authorId === currentUserId;

                let tagColorClass = "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300";
                if (post.tag === 'Feature') tagColorClass = "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400";
                if (post.tag === 'Bug') tagColorClass = "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";
                if (post.tag === 'Announcement') tagColorClass = "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400";

                const postContentHtml = isCurrentEditing
                    ? `
                        <input type="text" id="edit-title-${post.id}" class="w-full p-2 mb-2 font-bold text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="${escapeHtml(post.title || '')}" placeholder="Title">
                        <textarea id="edit-content-${post.id}" class="w-full h-32 p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">${escapeHtml(post.content || '')}</textarea>
                        <select id="edit-tag-${post.id}" class="w-full p-2 mt-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                            <option value="General" ${post.tag === 'General' ? 'selected' : ''}>General</option>
                            <option value="Feature" ${post.tag === 'Feature' ? 'selected' : ''}>Feature</option>
                            <option value="Bug" ${post.tag === 'Bug' ? 'selected' : ''}>Bug</option>
                            <option value="Announcement" ${post.tag === 'Announcement' ? 'selected' : ''}>Announcement</option>
                        </select>
                        <input type="url" id="edit-link-${post.id}" class="w-full p-2 mt-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="${escapeHtml(post.link || '')}" placeholder="Link/Image URL">
                      `
                    : `
                        ${post.title ? `<h3 class="text-base font-bold text-gray-900 dark:text-white mb-2">${escapeHtml(post.title)}</h3>` : ''}
                        <p class="whitespace-pre-wrap text-sm leading-relaxed text-gray-700 dark:text-gray-300">${escapeHtml(post.content)}</p>
                        ${post.link ? renderMedia(post.link) : ''}
                      `;

                const postControls = (isAdmin || isAuthor) ? `
                    <div class="flex gap-2">
                        <button data-action="${isCurrentEditing ? 'save-edit' : 'edit-post'}" 
                            data-post-id="${post.id}"
                            class="p-1 text-xs font-medium rounded-md ${isCurrentEditing ? 'bg-green-600 text-white hover:bg-green-700' : 'text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20'}">
                            <i data-lucide="${isCurrentEditing ? 'save' : 'edit'}" class="w-3 h-3 mr-1 inline"></i>
                            ${isCurrentEditing ? 'Save' : 'Edit'}
                        </button>
                        ${!isCurrentEditing ? `
                            <button data-action="delete-post" data-post-id="${post.id}" class="p-1 text-xs font-medium rounded-md text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">
                                <i data-lucide="trash-2" class="w-3 h-3 mr-1 inline"></i>
                                Delete
                            </button>
                        ` : ''}
                    </div>
                ` : '';

                const reactionButton = `
                    <button data-action="toggle-reaction" 
                            data-post-id="${post.id}" 
                            data-reacted="${hasReacted}"
                            class="flex items-center gap-1.5 p-1 px-2 text-xs rounded-full transition-colors ${hasReacted ? 'bg-red-500 text-white hover:bg-red-600' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}">
                        <i data-lucide="heart" class="w-3.5 h-3.5 fill-current ${hasReacted ? '' : 'fill-none'}"></i>
                        <span class="font-medium">${reactionCount}</span>
                    </button>
                `;

                return `
                    <div class="group relative pl-6 pb-8 last:pb-0">
                        <div class="timeline-dot absolute -left-[5px] top-1.5 h-2.5 w-2.5 rounded-full bg-blue-500 ring-4 ring-gray-50 dark:ring-gray-950"></div>
                        
                        <div class="flex flex-col gap-1.5">
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-medium text-gray-900 dark:text-gray-200 text-xs">
                                        ${post.authorId === 'admin' ? 'Admin Post' : 'Member'}
                                        ${isAdmin ? `<span class="text-gray-400 font-mono text-[10px] ml-1 select-all" title="Author ID">${escapeHtml(post.authorId)}</span>` : ''}
                                    </span>
                                    <span class="text-xs text-gray-400">
                                        &bull; ${formatRelativeTime(post.createdAt)}
                                    </span>
                                    ${post.tag ? `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold tracking-wide uppercase ${tagColorClass}">${escapeHtml(post.tag)}</span>` : ''}
                                </div>
                                ${postControls}
                            </div>

                            ${postContentHtml}
                            
                            <div class="flex justify-end pt-1">
                                ${reactionButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function renderMedia(url) {
            const safeUrl = escapeHtml(url);
            if (isImageUrl(url)) {
                return `
                    <div class="mt-3 overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 max-w-md">
                        <img src="${safeUrl}" alt="Post image" class="w-full h-auto object-cover max-h-80" 
                             onerror="this.onerror=null; this.src='https://placehold.co/400x200/94a3b8/ffffff?text=Image+Load+Failed';">
                    </div>
                `;
            } else {
                return `
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer"
                       class="flex items-center gap-3 p-3 mt-3 rounded-lg border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors w-full max-w-sm group">
                        <div class="h-8 w-8 flex items-center justify-center rounded bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 shrink-0 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-4 h-4" aria-label="External Link"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-xs font-medium text-blue-600 dark:text-blue-400 truncate">${safeUrl}</p>
                            <p class="text-[10px] text-gray-500 uppercase tracking-wide">External Link</p>
                        </div>
                    </a>
                `;
            }
        }
        
        // NEW: Tool Rendering functions
        function renderTools() {
            toolsLoadingMessage.classList.add('hidden');
            
            if (tools.length === 0) {
                toolsListContainer.innerHTML = `
                    <p class="col-span-full text-center text-gray-400 py-10">No downloadable tools have been added yet.</p>
                `;
                return;
            }

            toolsListContainer.innerHTML = tools.map(tool => `
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-5 flex flex-col justify-between h-full">
                    <div>
                        <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-2">${escapeHtml(tool.title)}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${escapeHtml(tool.description)}</p>
                    </div>
                    <a href="${escapeHtml(tool.link)}" target="_blank" rel="noopener noreferrer" 
                       class="mt-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-colors disabled:opacity-50">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download
                    </a>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderManagedTools() {
            if (!isAdmin) {
                managedToolsList.innerHTML = '';
                return;
            }
            
            // Render the list of tools for editing/deleting
            managedToolsList.innerHTML = `
                <h4 class="text-sm font-semibold mb-2">Available Tools (${tools.length})</h4>
                ${tools.map(tool => `
                    <div id="managed-tool-${tool.id}" class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg flex items-center justify-between">
                        <span class="text-sm font-medium truncate">${escapeHtml(tool.title)}</span>
                        <div class="flex gap-2 shrink-0">
                            <button data-action="edit-tool" data-tool-id="${tool.id}" class="text-blue-500 hover:text-blue-700 p-1 rounded transition-colors" title="Edit">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button data-action="delete-tool" data-tool-id="${tool.id}" class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
            lucide.createIcons();
        }


        // --- EVENTS ---
        
        feedContainer.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const postId = target.dataset.postId;
            const hasReacted = target.dataset.reacted === 'true';
            const currentUserId = currentUser ? currentUser.uid : null;

            if (!currentUserId) {
                 handleError("Authentication required.");
                 return;
            }
            
            const post = posts.find(p => p.id === postId);
            const isAuthor = post && post.authorId === currentUserId;
            const canEditOrDelete = isAdmin || isAuthor;

            switch(action) {
                case 'toggle-reaction':
                    toggleReaction(postId, currentUserId, hasReacted);
                    break;
                case 'edit-post':
                    if (canEditOrDelete) toggleEdit(postId, false);
                    else handleError("Admin or Post Author privileges required.");
                    break;
                case 'save-edit':
                    if (canEditOrDelete) toggleEdit(postId, true);
                    else handleError("Admin or Post Author privileges required to save.");
                    break;
                case 'delete-post':
                    if (canEditOrDelete) deletePost(postId);
                    else handleError("Admin or Post Author privileges required to delete.");
                    break;
            }
        });
        
        // NEW: Tool Admin Button Logic (Add/Save Tool)
        addToolBtn.addEventListener('click', async () => {
            const title = toolTitleInput.value.trim();
            const description = toolDescriptionInput.value.trim();
            const link = toolLinkInput.value.trim();
            
            if (!isAdmin) return handleError("Only Admin can manage tools.");

            if (!title || !description || !link) {
                return handleError("All fields are required to add/save a tool.");
            }

            addToolBtn.disabled = true;
            addToolBtn.textContent = editingToolId ? 'Saving...' : 'Adding...';

            try {
                const toolData = {
                    title,
                    description,
                    link,
                    createdAt: serverTimestamp()
                };

                if (editingToolId) {
                    // Update existing tool
                    await setDoc(doc(db, 'tools', editingToolId), toolData);
                    handleSuccess("Tool updated successfully!");
                } else {
                    // Add new tool
                    await addDoc(collection(db, 'tools'), toolData);
                    handleSuccess("New tool added successfully!");
                }
                
                // Reset form
                toolTitleInput.value = '';
                toolDescriptionInput.value = '';
                toolLinkInput.value = '';
                editingToolId = null;
                addToolBtn.textContent = 'Add New Tool';
            } catch (err) {
                if (err.code === 'permission-denied') {
                    handleError("Action blocked. Missing or insufficient permissions. Check your Firestore Security Rules for the 'tools' collection.");
                } else {
                    handleError("Failed to save tool.");
                }
                console.error(err);
            } finally {
                addToolBtn.disabled = false;
                lucide.createIcons();
            }
        });

        // The rest of the event listeners remain the same for post CRUD and tool list actions
        // ... (existing post CRUD functions and tool management event delegation)

        submitBtn.addEventListener('click', async () => {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            const link = linkInput.value.trim();
            const tag = selectedTag;

            if (!currentUser) return handleError("Not authenticated.");

            if (!content && !link && !title) {
                composerCard.classList.add('flash-red');
                setTimeout(() => composerCard.classList.remove('flash-red'), 500);
                return handleError("Please enter a title, content, or link.");
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Posting...';

            try {
                await addDoc(collection(db, COLLECTION_NAME), {
                    title,
                    content,
                    link,
                    tag,
                    authorId: isAdmin ? 'admin' : currentUser.uid, 
                    createdAt: serverTimestamp(),
                    reactions: {}
                });
                titleInput.value = '';
                contentInput.value = '';
                linkInput.value = '';
                selectedTag = 'General';
                updateTagSelection('General');
                handleSuccess("Update posted successfully!"); 
            } catch (err) {
                handleError("Failed to post. Check your Firestore Security Rules.");
                console.error(err);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Post Update</span><i data-lucide="send" class="w-3.5 h-3.5"></i>';
                lucide.createIcons();
            }
        });

        const toggleReaction = async (postId, userId, hasReacted) => {
            const docRef = doc(db, COLLECTION_NAME, postId);
            try {
                const post = posts.find(p => p.id === postId);
                if (!post) return;
                let newReactions = { ...post.reactions };
                if (hasReacted) delete newReactions[userId];
                else newReactions[userId] = true;
                await updateDoc(docRef, { reactions: newReactions });
            } catch (e) { handleError("Failed to update reaction."); }
        };

        const toggleEdit = async (id, currentlyEditing) => {
            if (!id) return; 

            if (currentlyEditing) {
                const newTitle = document.getElementById(`edit-title-${id}`).value.trim();
                const newContent = document.getElementById(`edit-content-${id}`).value.trim();
                const newLink = document.getElementById(`edit-link-${id}`).value.trim();
                const newTag = document.getElementById(`edit-tag-${id}`).value;
                const originalPost = posts.find(p => p.id === id);

                try {
                    await setDoc(doc(db, COLLECTION_NAME, id), { 
                        title: newTitle,
                        content: newContent, 
                        link: newLink,
                        tag: newTag,
                        authorId: originalPost.authorId,
                        createdAt: originalPost.createdAt,
                        reactions: originalPost.reactions
                    });
                    editingPostId = null;
                    applySearchFilter();
                    handleSuccess("Post saved successfully!"); 
                } catch (e) { handleError("Failed to save."); }
            } else {
                editingPostId = id;
                applySearchFilter();
            }
        };

        const deletePost = async (id) => {
            if (!id) return;
            if (!confirm("Are you sure you want to delete this post?")) return;
            try { 
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                handleSuccess("Post deleted."); 
            } 
            catch(e) { handleError("Delete failed. Check security rules."); }
        };
        
        pcstoolsView.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target || !isAdmin) return;
            
            const action = target.dataset.action;
            const toolId = target.dataset.toolId;
            
            switch(action) {
                case 'edit-tool':
                    startToolEdit(toolId);
                    break;
                case 'delete-tool':
                    deleteTool(toolId);
                    break;
            }
        });

        function startToolEdit(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            editingToolId = toolId;
            toolTitleInput.value = tool.title;
            toolDescriptionInput.value = tool.description;
            toolLinkInput.value = tool.link;
            addToolBtn.textContent = 'Save Changes';
            handleSuccess(`Editing: ${tool.title}`);
        }

        async function deleteTool(toolId) {
            if (!confirm("Are you sure you want to delete this tool?")) return;
            try {
                await deleteDoc(doc(db, 'tools', toolId));
                handleSuccess("Tool deleted successfully.");
            } catch (e) {
                handleError("Failed to delete tool. Check security rules.");
                console.error(e);
            }
        }


        // --- UTILS ---
        
        function calculateDecimalTime() {
            const hours = parseInt(hoursInput.value) || 0;
            const minutes = parseInt(minutesInput.value) || 0;
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return;
            decimalResult.textContent = (hours + (minutes / 60)).toFixed(2);
        }
        hoursInput.addEventListener('input', calculateDecimalTime);
        minutesInput.addEventListener('input', calculateDecimalTime);

        function calculatePercentage() {
            const x = parseFloat(percentX.value) || 0;
            const y = parseFloat(percentY.value) || 0;
            percentageResult.textContent = ((x / 100) * y).toFixed(2).replace(/\.00$/, '');
        }
        percentX.addEventListener('input', calculatePercentage);
        percentY.addEventListener('input', calculatePercentage);

        clearLinkBtn.addEventListener('click', () => linkInput.value = '');

        const toggleTheme = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
            lucide.createIcons();
        };

        darkModeToggle.addEventListener('click', toggleTheme);
        darkModeToggleMobile.addEventListener('click', toggleTheme);


        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollToTopBtn.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                scrollToToBtn.classList.remove('opacity-100', 'pointer-events-auto');
            }
        };
        scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        function formatRelativeTime(ts) {
            if (!ts || !ts.seconds) return 'Just now';
            const seconds = Math.floor((new Date() - (ts.seconds * 1000)) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 30) return `${days}d ago`;
            return new Date(ts.seconds * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function handleError(msg) {
            errorMessage.textContent = msg;
            errorContainer.classList.remove('hidden');
            setTimeout(() => errorContainer.classList.add('hidden'), 5000);
        }
        
        function handleSuccess(msg) {
            successMessage.textContent = msg;
            successContainer.classList.remove('hidden');
            setTimeout(() => successContainer.classList.add('hidden'), 5000);
        }

        function escapeHtml(text) {
            if (!text) return text;
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        // Final initialization calls
        calculateDecimalTime(); 
        calculatePercentage();
        lucide.createIcons();
        // Manually trigger gapi load after <body> has loaded
        window.gapi.load('client', window.gapiLoaded);
    </script>
</body>
</html>
