<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCS Updates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Set up dark mode based on localStorage or system preference (Prevents FOUC)
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Adjusted timeline-dot ring color for better contrast */
        .timeline-dot {
            box-shadow: 0 0 0 4px #f9fafb; 
        }
        @media (prefers-color-scheme: dark) {
            .timeline-dot { box-shadow: 0 0 0 4px #030712; }
        }
        .converter-input {
            appearance: textfield; 
        }
        .converter-input::-webkit-outer-spin-button,
        .converter-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Keyframes for flash effect on empty post click */
        @keyframes flash-red {
            0%, 100% { border-color: rgb(229 231 235); }
            50% { border-color: rgb(239 68 68); }
        }
        .flash-red {
            animation: flash-red 0.5s ease-in-out;
        }
        .tag-pill.selected {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border-color: #2563eb;
        }
        .dark .tag-pill.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background-color: #334155;
        }
        
        /* Restored: Timeline Structure Enhancement */
        #posts-feed {
            /* Add a persistent left border to the whole feed container */
            border-left: 1px solid #e5e7eb; /* gray-200 */
        }
        .dark #posts-feed {
             border-left: 1px solid #1f2937; /* gray-800 */
        }
        .post-container {
            /* Reset the left border on individual posts */
            border-left: none !important;
        }

        /* --- TSC HELPER STYLES (SCOPED) --- */
        #tsc-helper-view .container-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 100px); /* Adjusting for header */
            padding: 1rem;
        }
        .dark #tsc-helper-view h2, .dark #tsc-helper-view h3 { color: #f1f5f9; }
        .dark #tsc-helper-view .container {
            background-color: #334155;
            padding: 2.5rem;
            border-radius: 0.75rem;
            border: 1px solid #475569;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1400px;
        }
        #tsc-helper-view .time-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            overflow: hidden;
            font-size: 0.9rem;
        }
        #tsc-helper-view .time-table th, #tsc-helper-view .time-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #475569;
            vertical-align: middle;
        }
        #tsc-helper-view .time-table th {
            background-color: #475569;
            color: #f1f5f9;
            font-weight: 600;
        }
        #tsc-helper-view .time-table td { font-family: monospace; font-size: 0.95rem; color: #e2e8f0; }
        #tsc-helper-view .time-table tbody tr:last-child td { border-bottom: none; }
        #tsc-helper-view .time-table tbody tr:hover { background-color: #404d61; }
        #tsc-helper-view .time-table select {
            width: 100%; background-color: #334155; color: #f1f5f9;
            border: 1px solid #64748b; border-radius: 0.375rem; padding: 0.35rem;
            font-family: "Inter", sans-serif; font-size: 0.85rem;
        }
        #tsc-helper-view .time-table select:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        #tsc-helper-view .time-table input.editable-date {
            background-color: transparent;
            border: none;
            color: #e2e8f0;
            padding: 0;
            font-size: 0.95rem;
            font-family: monospace;
            width: 100%;
        }
        #tsc-helper-view .time-table input.editable-date:focus {
            background-color: #1e293b;
            outline: 1px solid #3b82f6;
            border-radius: 2px;
        }
        #tsc-helper-view .button-remove {
            background-color: #be123c; color: white;
            padding: 0.3rem 0.6rem; border-radius: 0.25rem;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            border: none; transition: background-color 0.2s;
        }
        #tsc-helper-view .button-remove:hover { background-color: #9f1239; }
        #tsc-helper-view .button {
            padding: 0.75rem 1.5rem; margin: 0.5rem; border-radius: 0.375rem;
            cursor: pointer; font-size: 1rem; font-weight: 500;
            transition: all 0.2s ease-in-out; border: none;
        }
        #tsc-helper-view .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #tsc-helper-view .button-primary { background-color: #3b82f6; color: white; }
        #tsc-helper-view .button-primary:hover { background-color: #2563eb; }
        #tsc-helper-view .button-secondary { background-color: #475569; color: #f1f5f9; }
        #tsc-helper-view .button-secondary:hover { background-color: #64748b; }
        #tsc-helper-view .message-box {
            margin-top: 1.5rem; padding: 0.85rem; border-radius: 0.375rem;
            font-weight: 500; visibility: hidden; opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #tsc-helper-view .message-box.visible { visibility: visible; opacity: 1; }
        #tsc-helper-view .message-box:not(.error) { background-color: #166534; color: #dcfce7; border: 1px solid #22c55e; }
        #tsc-helper-view .message-box.error { background-color: #991b1b; color: #fee2e2; border: 1px solid #f87171; }
        #tsc-helper-view .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.75);
            justify-content: center; align-items: center;
        }
        #tsc-helper-view .modal-content {
            background-color: #334155; margin: auto; padding: 2rem;
            border: 1px solid #475569; width: 90%;
            border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            position: relative;
        }
        #tsc-helper-view .close-button {
            color: #94a3b8; font-size: 28px; font-weight: bold;
            position: absolute; top: 15px; right: 25px;
            cursor: pointer; transition: color 0.2s ease;
        }
        #tsc-helper-view .close-button:hover, #tsc-helper-view .close-button:focus { color: #f1f5f9; }
        #tsc-helper-view .form-group { margin-bottom: 1rem; }
        #tsc-helper-view .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.5rem; text-align: left; }
        #tsc-helper-view .form-group input, #tsc-helper-view .form-group select {
            width: 100%; background-color: #334155; color: #f1f5f9;
            border: 1px solid #64748b; border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #tsc-helper-view input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        #tsc-helper-view .form-group input:focus, #tsc-helper-view .form-group select:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 min-h-screen transition-colors">

    <div id="app" class="max-w-7xl mx-auto px-4 py-6">
        
        <header class="flex flex-col lg:flex-row items-center justify-between gap-6 mb-8">
            <div class="flex items-center gap-4 w-full lg:w-auto justify-between lg:justify-start">
                <h1 class="text-2xl font-bold tracking-tight whitespace-nowrap">PCS Updates</h1>
                
                <div class="flex lg:hidden items-center gap-2">
                    <button id="dark-mode-toggle-mobile" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
                        <i data-lucide="moon" class="w-5 h-5 hidden dark:inline"></i>
                    </button>
                    <button id="login-btn-mobile" class="px-3 py-1 bg-gray-200 dark:bg-gray-800 rounded-full text-xs hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">Admin</button>
                </div>
            </div>

            <div class="w-full lg:max-w-xl relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="Search timeline updates..." 
                    class="w-full py-2.5 pl-10 pr-4 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm">
            </div>
            
            <div class="hidden lg:flex items-center gap-3">
                <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors" title="Toggle Dark/Light Mode">
                    <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i>
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:inline"></i>
                </button>
                
                <div id="admin-status" class="text-xs font-medium text-red-500 hidden"></div>
                <button id="login-btn" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-800 rounded-full text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">Admin Login</button>
                
                <div id="user-status" class="h-9 w-9 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800 text-gray-500 dark:text-gray-400" title="Anonymous User">
                     <i data-lucide="user" class="w-5 h-5"></i>
                </div>
            </div>
        </header>

        <div id="nav-tabs" class="flex border-b border-gray-200 dark:border-gray-800 mb-6">
            <button data-view="timeline" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400">Timeline</button>
            <button data-view="tools" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Tools</button>
            <button data-view="pcstools" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">PCS Tools</button>
            <button data-view="tsc-helper" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">TSC Helper</button>
        </div>

        <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h2 class="text-xl font-bold mb-4">Admin Login</h2>
                <input id="admin-user" type="text" placeholder="Username (admin)" class="w-full p-2 mb-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="admin">
                <input id="admin-pass" type="password" placeholder="Password (admin)" class="w-full p-2 mb-4 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="admin">
                <div class="flex justify-end gap-3">
                    <button id="close-modal-btn" class="px-4 py-2 text-sm rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                    <button id="submit-login-btn" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Login</button>
                </div>
            </div>
        </div>
        
        <div id="success-container" class="hidden fixed top-4 right-4 z-50 max-w-sm bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-200 p-4 rounded-lg border border-green-200 dark:border-green-800 text-sm flex items-start gap-3 shadow-lg">
            <i data-lucide="check-circle" class="w-5 h-5 mt-0.5"></i>
            <span id="success-message">Update successful!</span>
            <button onclick="document.getElementById('success-container').classList.add('hidden')" class="ml-auto text-green-500 hover:text-green-700">&times;</button>
        </div>

        <div id="error-container" class="hidden fixed top-4 right-4 z-50 max-w-sm bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200 p-4 rounded-lg border border-red-200 dark:border-red-800 text-sm flex items-start gap-3 shadow-lg">
            <i data-lucide="alert-triangle" class="w-5 h-5 mt-0.5"></i>
            <span id="error-message"></span>
            <button onclick="document.getElementById('error-container').classList.add('hidden')" class="ml-auto text-red-500 hover:text-red-700">&times;</button>
        </div>

        <div id="timeline-view" class="view">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                
                <div class="lg:col-span-4 lg:sticky lg:top-4 space-y-4">
                    <div id="composer-card" class="bg-white dark:bg-gray-900 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800 p-5 transition-all duration-300">
                        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                            What's new?
                        </h2>

                        <input id="post-title" type="text" placeholder="Title (Optional)" 
                            class="w-full bg-transparent border-b border-gray-200 dark:border-gray-700 focus:border-blue-500 focus:ring-0 text-base font-semibold placeholder-gray-400 mb-3 pb-1 outline-none transition-colors">

                        <textarea id="post-content" placeholder="Type your update here..." 
                            class="w-full min-h-[120px] resize-none bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-transparent focus:bg-white dark:focus:bg-gray-900 focus:border-blue-500 focus:ring-0 text-sm placeholder-gray-400 mb-4 outline-none transition-all"></textarea>
                        
                        <div class="mb-4">
                            <div id="tag-selector" class="flex flex-wrap gap-2">
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="General">General</button>
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="Feature">Feature</button>
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="Bug">Bug</button>
                                <button type="button" class="tag-pill px-3 py-1 rounded-full text-[11px] font-medium border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" data-tag="Announcement">Announcement</button>
                            </div>
                        </div>

                        <div id="meta-input-container" class="space-y-3">
                            <div id="link-input-container" class="flex items-center gap-2 bg-gray-50 dark:bg-gray-800/50 px-3 py-2 rounded-lg border border-gray-100 dark:border-gray-800">
                                <i data-lucide="image" class="w-4 h-4 text-gray-400"></i>
                                <input type="url" id="link-url" placeholder="Optional Image/Link URL" 
                                    class="flex-1 bg-transparent border-0 focus:outline-none text-xs">
                                <button id="clear-link-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                            </div>

                            <button id="submit-btn" class="w-full flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all shadow-md shadow-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                                <span>Post Update</span>
                                <i data-lucide="send" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-400 px-2 text-center">
                        <p>Formatting Tip: Use standard text. URLs in the link field render as previews.</p>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div id="posts-feed" class="space-y-6 relative pb-12">
                        <div class="text-center py-20 text-gray-400 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-200 dark:border-gray-800">
                            <i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2 opacity-50"></i>
                            <span class="text-sm">Loading updates...</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="tools-view" class="view hidden max-w-3xl mx-auto">
            <h2 class="text-xl font-bold mb-6">Utility Tools</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
                    <h3 class="text-sm font-semibold mb-4 flex items-center gap-2 uppercase text-gray-500 tracking-wider">
                        <i data-lucide="clock" class="w-4 h-4 text-blue-500"></i>
                        Decimal Time
                    </h3>
                    <div class="flex gap-4 mb-4">
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">HOURS</label>
                            <input type="number" id="hours-input" min="0" max="23" placeholder="HH" value="8"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">MINUTES</label>
                            <input type="number" id="minutes-input" min="0" max="59" placeholder="MM" value="30"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
                        <p class="text-xs text-gray-400 mb-1">RESULT</p>
                        <p id="decimal-result" class="text-3xl font-bold text-blue-600 dark:text-blue-400">8.50</p>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6">
                    <h3 class="text-sm font-semibold mb-4 flex items-center gap-2 uppercase text-gray-500 tracking-wider">
                        <i data-lucide="percent" class="w-4 h-4 text-green-500"></i>
                        Percentage
                    </h3>
                    <div class="flex gap-2 mb-4 items-end">
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">VALUE</label>
                            <input type="number" id="percent-x" value="15"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                        <span class="text-sm text-gray-400 pb-3">% of</span>
                        <div class="flex-1">
                            <label class="block text-[10px] font-medium text-gray-500 mb-1">TOTAL</label>
                            <input type="number" id="percent-y" value="200"
                                class="converter-input w-full p-2 border rounded bg-gray-50 dark:bg-gray-800 dark:border-gray-700 text-center text-lg font-mono">
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
                        <p class="text-xs text-gray-400 mb-1">RESULT</p>
                        <p id="percentage-result" class="text-3xl font-bold text-green-600 dark:text-green-400">30</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="pcstools-view" class="view hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                <div id="tools-admin-panel" class="lg:col-span-1 space-y-4 hidden lg:sticky lg:top-4">
                    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800 p-5">
                        <h3 class="text-lg font-bold mb-4">Manage Tools</h3>
                        <input type="text" id="tool-title-input" placeholder="Tool Title" class="w-full p-2 mb-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm">
                        <textarea id="tool-description-input" placeholder="Tool Description" class="w-full p-2 mb-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm h-20 resize-none"></textarea>
                        <input type="url" id="tool-link-input" placeholder="Download Link (URL)" class="w-full p-2 mb-4 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-sm">
                        <button id="add-tool-btn" class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm">Add New Tool</button>
                    </div>
                    <div id="managed-tools-list" class="space-y-3 p-4 bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800">
                        </div>
                </div>

                <div class="lg:col-span-2">
                    <h2 class="text-xl font-bold mb-6">Downloadable PCS Tools</h2>
                    <div id="tools-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p id="tools-loading-message" class="col-span-full text-center text-gray-400 py-10">Loading tools...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="tsc-helper-view" class="view hidden">
            <div class="container-wrapper">
                <div class="container">
                    <h2 class="text-3xl font-bold mb-2">Time Segment Randomizer</h2>
                    <p class="text-slate-300 mb-8">Generates time-logged rows based on a series of time points with randomized seconds.</p>
                    <div id="durationWarning" class="hidden p-4 mb-4 text-sm text-yellow-200 bg-yellow-800 border border-yellow-700 rounded-lg text-left" role="alert"></div>
                    <table class="time-table">
                        <thead>
                            <tr>
                                <th>TechNumber</th><th>Username</th><th>Shift</th><th>Date</th><th>Start Time</th><th>End Time</th>
                                <th>Hours</th><th>MainCategory</th><th>SubCategory</th><th>OT</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="timeTableBody"></tbody>
                    </table>
                    <button id="randomizeButton" class="button button-primary">Randomize & Recalculate</button>
                    <button id="insertTaskButton" class="button bg-green-600 hover:bg-green-700 text-white">Insert Task</button>
                    <button id="copyButton" class="button button-secondary">Copy Table</button>
                    <button id="settingsButton" class="button button-secondary">Settings</button>
                    <button id="clearDataButton" class="button bg-red-700 hover:bg-red-800 text-white">Clear Data</button>
                    <div id="messageBox" class="message-box"></div>
                </div>

                <div id="settingsModal" class="modal">
                    <div class="modal-content" style="max-width: 896px;">
                        <span id="closeSettingsModalButton" class="close-button">&times;</span>
                        <h3 class="text-2xl font-semibold mb-6">Settings</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-[#1e293b] border border-slate-700 p-5 rounded-md">
                                <h4 class="text-lg font-semibold text-slate-200 mb-4 pb-2 border-b border-slate-600">General Info & Schedule</h4>
                                <div class="form-group">
                                    <label for="selectScheduleDropdown">Select Saved Schedule</label>
                                    <div class="flex items-center gap-2">
                                        <select id="selectScheduleDropdown" class="flex-grow"></select>
                                        <button id="deleteScheduleButton" class="button-remove !m-0 !py-2.5">Delete</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="!mb-2">Or, Generate a New Schedule</label>
                                    <button id="generateScheduleButton" class="button !m-0 bg-indigo-600 hover:bg-indigo-700 text-sm w-full py-2 px-3">Open Schedule Generator</button>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group"><label for="techNumberInput">Tech Number</label><input type="text" id="techNumberInput"></div>
                                    <div class="form-group"><label for="usernameInput">Username</label><input type="text" id="usernameInput"></div>
                                    <div class="form-group"><label for="shiftInput">Shift</label><select id="shiftInput"><option value="Day">Day</option><option value="Night">Night</option></select></div>
                                    <div class="form-group"><label for="dateInput">Start Date</label><input type="date" id="dateInput"></div>
                                    <div class="form-group col-span-2"><label for="otInput">OT</label><select id="otInput"><option value="NO">NO</option><option value="YES">YES</option></select></div>
                                </div>
                            </div>
                            <div class="bg-[#1e293b] border border-slate-700 p-5 rounded-md">
                                <h4 class="text-lg font-semibold text-slate-200 mb-4 pb-2 border-b border-slate-600">Default Category</h4>
                                <p class="text-slate-400 font-normal text-sm -mt-4 mb-4">Used for all non-break segments.</p>
                                <div class="form-group mt-4"><label for="mainCatSelect">Main Category</label><select id="mainCatSelect"></select></div>
                                <div class="form-group"><label for="subCatSelect">Sub Category</label><select id="subCatSelect"></select></div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-slate-600">
                            <button id="resetSettingsButton" class="button bg-yellow-600 hover:bg-yellow-700 text-white">Reset All Data</button>
                            <div>
                                <button id="saveSettingsButton" class="button button-primary mr-2">Save & Apply</button>
                                <button id="cancelSettingsButton" class="button button-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="scheduleModal" class="modal">
                    <div class="modal-content max-w-md">
                        <h3 class="text-2xl font-semibold mb-6">Generate Time Points</h3>
                        <div class="space-y-4">
                            <div class="form-group !mb-6">
                                <label for="scheduleTemplateNameInput">Schedule Name (for saving)</label>
                                <input type="text" id="scheduleTemplateNameInput" placeholder="e.g., Weekday Shift">
                            </div>
                            <div class="form-group"><label for="schedTimeIn">Time IN</label><input type="time" id="schedTimeIn" class="w-full"></div>
                            <div class="form-group"><label for="schedBreak1">1st Break Start (15 min)</label><input type="time" id="schedBreak1" class="w-full"></div>
                            <div class="form-group"><label for="schedLunch">Lunch Start (1 hour)</label><input type="time" id="schedLunch" class="w-full"></div>
                            <div class="form-group"><label for="schedBreak2">2nd Break Start (15 min)</label><input type="time" id="schedBreak2" class="w-full"></div>
                            <div class="form-group"><label for="schedTimeOut">Time OUT</label><input type="time" id="schedTimeOut" class="w-full"></div>
                        </div>
                        <div id="scheduleErrorMessage" class="text-red-400 mt-4 text-sm h-4"></div>
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-slate-600">
                            <button id="saveScheduleTemplateButton" class="button button-secondary !m-0">Save Template</button>
                            <div>
                                <button id="applyScheduleButton" class="button button-primary mr-2">Apply</button>
                                <button id="cancelScheduleButton" class="button button-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="insertTaskModal" class="modal">
                    <div class="modal-content max-w-lg">
                        <span id="closeTaskModalButton" class="close-button">&times;</span>
                        <h3 class="text-2xl font-semibold mb-6">Insert New Task</h3>
                        <div class="space-y-4">
                            <div class="form-group"><label for="taskSegmentSelect">Split this time segment:</label><select id="taskSegmentSelect"></select></div>
                            <div class="form-group"><label for="taskDurationInput">New Task Duration (in minutes)</label><input type="number" id="taskDurationInput" placeholder="e.g., 20"></div>
                            <div class="form-group"><label for="taskMainCatSelect">New Task Main Category</label><select id="taskMainCatSelect"></select></div>
                            <div class="form-group"><label for="taskSubCatSelect">New Task Sub Category</label><select id="taskSubCatSelect"></select></div>
                        </div>
                        <div id="taskErrorMessage" class="text-red-400 mt-4 text-sm h-4"></div>
                        <div class="flex justify-end items-center mt-6 pt-4 border-t border-slate-600">
                            <button id="applyTaskButton" class="button button-primary mr-2">Insert Task</button>
                            <button id="cancelTaskButton" class="button button-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="scroll-to-top" class="fixed bottom-4 right-4 p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-opacity duration-300 opacity-0 pointer-events-none z-40">
        <i data-lucide="arrow-up" class="w-5 h-5"></i>
    </button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, setDoc, updateDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

        // --- CONFIGURATION START ---
        const firebaseConfig = {
            apiKey: "AIzaSyBBcrvThge1YHswamX_pb7KghiCm5ROUH8",
            authDomain: "pcs-updates.firebaseapp.com",
            projectId: "pcs-updates",
            storageBucket: "pcs-updates.firebasestorage.app",
            messagingSenderId: "424424316130",
            appId: "1:424424316130:web:84f63aab43b4687b08d2bb"
        };
        // --- CONFIGURATION END ---
        
        // --- ADMIN CONFIG (HARDCODED) ---
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin'; 

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = 'posts';

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let isAdmin = false;
        let posts = [];
        let tools = []; 
        let filteredPosts = [];
        let editingPostId = null;
        let editingToolId = null; 
        let currentView = 'timeline';
        let selectedTag = 'General';

        // --- NEW TSC HELPER STATE & CONSTANTS ---
        const LOCAL_STORAGE_KEY = 'timeRandomizerSettings_v26_editIcon';
        const SCHEDULE_TEMPLATES_KEY = 'timeRandomizerScheduleTemplates_v1';
        const DURATION_LIMIT_SECONDS = 27000;
        const categoryData = { "BREAK": ["BREAK"], "SARANAC": ["CF"], "ACCUPLUS": ["DEM", "I3", "PCS", "REFIX", "i3QA", "RQA"], "DOWNTIME": ["System", "NoProject"], "TRAINING": ["Formal - Accuplus"] };
        let currentSettings = {};
        let currentDisplayedData = [];
        let randomizedTimes = [];

        // --- DOM ELEMENTS ---
        const userStatus = document.getElementById('user-status');
        const feedContainer = document.getElementById('posts-feed');
        const submitBtn = document.getElementById('submit-btn');
        const composerCard = document.getElementById('composer-card');
        const titleInput = document.getElementById('post-title');
        const contentInput = document.getElementById('post-content');
        const linkInput = document.getElementById('link-url');
        const tagSelector = document.getElementById('tag-selector');
        const tagPills = document.querySelectorAll('.tag-pill');
        const clearLinkBtn = document.getElementById('clear-link-btn');
        const searchInput = document.getElementById('search-input');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeToggleMobile = document.getElementById('dark-mode-toggle-mobile');
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        
        // Modal/Admin elements
        const loginBtn = document.getElementById('login-btn');
        const loginBtnMobile = document.getElementById('login-btn-mobile');
        const loginModal = document.getElementById('login-modal');
        const submitLoginBtn = document.getElementById('submit-login-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const adminUser = document.getElementById('admin-user');
        const adminPass = document.getElementById('admin-pass');
        const adminStatus = document.getElementById('admin-status');

        const timelineView = document.getElementById('timeline-view');
        const toolsView = document.getElementById('tools-view');
        const pcstoolsView = document.getElementById('pcstools-view'); 
        const navTabs = document.querySelectorAll('.tab-btn');
        
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const successContainer = document.getElementById('success-container'); 
        const successMessage = document.getElementById('success-message');     

        // Tool inputs
        const hoursInput = document.getElementById('hours-input');
        const minutesInput = document.getElementById('minutes-input');
        const decimalResult = document.getElementById('decimal-result');
        const percentX = document.getElementById('percent-x');
        const percentY = document.getElementById('percent-y');
        const percentageResult = document.getElementById('percentage-result');
        
        // NEW: PCS Tools Admin Elements
        const toolsAdminPanel = document.getElementById('tools-admin-panel');
        const toolsListContainer = document.getElementById('tools-list-container');
        const toolsLoadingMessage = document.getElementById('tools-loading-message');
        const managedToolsList = document.getElementById('managed-tools-list');
        const toolTitleInput = document.getElementById('tool-title-input');
        const toolDescriptionInput = document.getElementById('tool-description-input');
        const toolLinkInput = document.getElementById('tool-link-input');
        const addToolBtn = document.getElementById('add-tool-btn');

        // NEW: TSC Helper Elements
        const tscHelperView = document.getElementById('tsc-helper-view');
        const timeTableBody = document.getElementById('timeTableBody');
        const randomizeButton = document.getElementById('randomizeButton');
        const copyButton = document.getElementById('copyButton');
        const messageBox = document.getElementById('messageBox');
        const insertTaskButton = document.getElementById('insertTaskButton');
        const settingsButton = document.getElementById('settingsButton');
        const durationWarning = document.getElementById('durationWarning');
        const clearDataButton = document.getElementById('clearDataButton');
        const settingsModal = document.getElementById('settingsModal');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const cancelSettingsButton = document.getElementById('cancelSettingsButton');
        const closeSettingsModalButton = document.getElementById('closeSettingsModalButton');
        const resetSettingsButton = document.getElementById('resetSettingsButton');
        const selectScheduleDropdown = document.getElementById('selectScheduleDropdown');
        const deleteScheduleButton = document.getElementById('deleteScheduleButton');
        const scheduleModal = document.getElementById('scheduleModal');
        const generateScheduleButton = document.getElementById('generateScheduleButton');
        const applyScheduleButton = document.getElementById('applyScheduleButton');
        const cancelScheduleButton = document.getElementById('cancelScheduleButton');
        const saveScheduleTemplateButton = document.getElementById('saveScheduleTemplateButton');
        const scheduleErrorMessage = document.getElementById('scheduleErrorMessage');
        const insertTaskModal = document.getElementById('insertTaskModal');
        const closeTaskModalButton = document.getElementById('closeTaskModalButton');
        const applyTaskButton = document.getElementById('applyTaskButton');
        const cancelTaskButton = document.getElementById('cancelTaskButton');
        const taskErrorMessage = document.getElementById('taskErrorMessage');


        // --- AUTH & INITIALIZATION ---

        signInAnonymously(auth).catch((e) => {
             console.error("Auth failed", e);
             handleError("Authentication failed.");
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Updated User UI in Header
                userStatus.className = "h-9 w-9 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-400 font-bold border border-blue-200 dark:border-blue-800";
                userStatus.innerHTML = '<i data-lucide="user-check" class="w-5 h-5"></i>';
                userStatus.title = `Connected as Member`;
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Post Update</span><i data-lucide="send" class="w-3.5 h-3.5"></i>';

                initRealtimeListener();
                initToolsListener(); 
            } else {
                currentUser = null;
                userStatus.className = "h-9 w-9 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-800 text-gray-400 animate-pulse";
                userStatus.innerHTML = '<i data-lucide="user" class="w-5 h-5"></i>';
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span>Waiting for Auth...</span><i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i>';
            }
            lucide.createIcons();
            updateAdminUI();
        });

        // --- UI/VIEW MANAGEMENT ---

        function switchView(viewName) {
            currentView = viewName;
            // UPDATED to include tscHelperView
            [timelineView, toolsView, pcstoolsView, tscHelperView].forEach(view => {
                view.classList.toggle('hidden', view.id !== `${viewName}-view`);
            });
            navTabs.forEach(tab => {
                const isActive = tab.dataset.view === viewName;
                tab.classList.toggle('border-blue-600', isActive);
                tab.classList.toggle('text-blue-600', isActive);
                tab.classList.toggle('dark:text-blue-400', isActive);
                tab.classList.toggle('border-transparent', !isActive);
                tab.classList.toggle('text-gray-500', !isActive);
            });
            
            if (viewName === 'pcstools') {
                updateToolsAdminPanel(); 
            }
            
            lucide.createIcons();
        }

        navTabs.forEach(tab => {
            tab.addEventListener('click', () => switchView(tab.dataset.view));
        });

        // --- TAG SELECTION LOGIC ---
        
        updateTagSelection(selectedTag);

        tagPills.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedTag = btn.dataset.tag;
                updateTagSelection(selectedTag);
            });
        });

        function updateTagSelection(tag) {
            tagPills.forEach(btn => {
                if (btn.dataset.tag === tag) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        // --- ADMIN LOGIN LOGIC ---

        function updateAdminUI() {
            if (isAdmin) {
                adminStatus.textContent = 'ADMIN';
                adminStatus.classList.remove('hidden');
                loginBtn.textContent = 'Logout';
                loginBtnMobile.textContent = 'Logout';
                
                const logoutHandler = () => handleLogout();
                loginBtn.onclick = logoutHandler;
                loginBtnMobile.onclick = logoutHandler;
            } else {
                adminStatus.textContent = '';
                adminStatus.classList.add('hidden');
                loginBtn.textContent = 'Admin Login';
                loginBtnMobile.textContent = 'Admin';
                
                const loginHandler = () => loginModal.classList.remove('hidden');
                loginBtn.onclick = loginHandler;
                loginBtnMobile.onclick = loginHandler;
            }
            
            if (currentView === 'pcstools') {
                updateToolsAdminPanel();
            }
            applySearchFilter();
        }
        
        function updateToolsAdminPanel() {
            if (currentView === 'pcstools') {
                toolsAdminPanel.classList.toggle('hidden', !isAdmin);
                renderManagedTools();
            }
        }
        
        function handleLogin() {
            if (adminUser.value === ADMIN_USERNAME && adminPass.value === ADMIN_PASSWORD) {
                isAdmin = true;
                loginModal.classList.add('hidden');
                updateAdminUI();
                handleSuccess("Admin login successful."); 
            } else {
                handleError("Invalid credentials.");
            }
        }

        function handleLogout() {
            isAdmin = false;
            adminUser.value = ADMIN_USERNAME;
            adminPass.value = ADMIN_PASSWORD;
            updateAdminUI();
            handleSuccess("Logged out of Admin account."); 
        }

        submitLoginBtn.addEventListener('click', handleLogin);
        closeModalBtn.addEventListener('click', () => {
             adminUser.value = ADMIN_USERNAME; // Reset to default
             adminPass.value = ADMIN_PASSWORD; // Reset to default
             loginModal.classList.add('hidden');
        });

        // --- FIRESTORE DATA ---

        function initRealtimeListener() {
            if (!currentUser) return;
            
            onSnapshot(collection(db, COLLECTION_NAME), (snapshot) => {
                posts = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    reactions: doc.data().reactions || {} 
                }));
                posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                applySearchFilter();
            }, (error) => {
                console.error(error);
                if(error.code === 'permission-denied') handleError("Permission denied loading posts.");
            });
        }
        
        function initToolsListener() {
            onSnapshot(collection(db, 'tools'), (snapshot) => {
                tools = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data()
                }));
                tools.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderTools();
                if (isAdmin) renderManagedTools();
            }, (error) => {
                console.error("Tools listener failed", error);
                // Inform user about security rules if permission is denied
                if(error.code === 'permission-denied') handleError("Tools listener failed: Missing or insufficient permissions. Check Firestore Security Rules for the 'tools' collection.");
                else handleError("Failed to load tools.");
            });
        }

        // --- SEARCH FUNCTIONALITY ---
        searchInput.addEventListener('input', applySearchFilter);

        function applySearchFilter() {
            const query = searchInput.value.toLowerCase().trim();
            
            if (query === '') {
                filteredPosts = posts;
            } else {
                filteredPosts = posts.filter(post => 
                    (post.title && post.title.toLowerCase().includes(query)) ||
                    post.content.toLowerCase().includes(query) || 
                    (post.tag && post.tag.toLowerCase().includes(query))
                );
            }
            renderPosts(filteredPosts);
        }

        // --- POST RENDERING & CRUD ---

        function isImageUrl(url) {
            return (url || '').match(/\.(jpeg|jpg|gif|png|webp|svg)$/i) !== null;
        }

        function renderPosts(currentPosts) {
            // ... (rest of renderPosts logic remains the same)
            if (currentPosts.length === 0) {
                const message = searchInput.value.trim() ? "No results found." : "No updates yet.";
                feedContainer.innerHTML = `
                    <div class="text-center py-20 text-gray-400 bg-white dark:bg-gray-900 rounded-xl border border-dashed border-gray-200 dark:border-gray-800">
                        <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-4 opacity-50"></i>
                        <p>${message}</p>
                    </div>`;
                lucide.createIcons();
                return;
            }
            
            const currentUserId = currentUser ? currentUser.uid : 'temp-anon-user';

            feedContainer.innerHTML = currentPosts.map(post => {
                const isCurrentEditing = editingPostId === post.id;
                const postReactions = post.reactions;
                const reactionCount = Object.keys(postReactions).length;
                const hasReacted = currentUserId !== 'temp-anon-user' && postReactions[currentUserId];
                
                const isAuthor = post.authorId === currentUserId;

                let tagColorClass = "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300";
                if (post.tag === 'Feature') tagColorClass = "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400";
                if (post.tag === 'Bug') tagColorClass = "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";
                if (post.tag === 'Announcement') tagColorClass = "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400";

                const postContentHtml = isCurrentEditing
                    ? `
                        <input type="text" id="edit-title-${post.id}" class="w-full p-2 mb-2 font-bold text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="${escapeHtml(post.title || '')}" placeholder="Title">
                        <textarea id="edit-content-${post.id}" class="w-full h-32 p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">${escapeHtml(post.content || '')}</textarea>
                        <select id="edit-tag-${post.id}" class="w-full p-2 mt-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                            <option value="General" ${post.tag === 'General' ? 'selected' : ''}>General</option>
                            <option value="Feature" ${post.tag === 'Feature' ? 'selected' : ''}>Feature</option>
                            <option value="Bug" ${post.tag === 'Bug' ? 'selected' : ''}>Bug</option>
                            <option value="Announcement" ${post.tag === 'Announcement' ? 'selected' : ''}>Announcement</option>
                        </select>
                        <input type="url" id="edit-link-${post.id}" class="w-full p-2 mt-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" value="${escapeHtml(post.link || '')}" placeholder="Link/Image URL">
                      `
                    : `
                        ${post.title ? `<h3 class="text-base font-bold text-gray-900 dark:text-white mb-2">${escapeHtml(post.title)}</h3>` : ''}
                        <p class="whitespace-pre-wrap text-sm leading-relaxed text-gray-700 dark:text-gray-300">${escapeHtml(post.content)}</p>
                        ${post.link ? renderMedia(post.link) : ''}
                      `;

                const postControls = (isAdmin || isAuthor) ? `
                    <div class="flex gap-2">
                        <button data-action="${isCurrentEditing ? 'save-edit' : 'edit-post'}" 
                            data-post-id="${post.id}"
                            class="p-1 text-xs font-medium rounded-md ${isCurrentEditing ? 'bg-green-600 text-white hover:bg-green-700' : 'text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20'}">
                            <i data-lucide="${isCurrentEditing ? 'save' : 'edit'}" class="w-3 h-3 mr-1 inline"></i>
                            ${isCurrentEditing ? 'Save' : 'Edit'}
                        </button>
                        ${!isCurrentEditing ? `
                            <button data-action="delete-post" data-post-id="${post.id}" class="p-1 text-xs font-medium rounded-md text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">
                                <i data-lucide="trash-2" class="w-3 h-3 mr-1 inline"></i>
                                Delete
                            </button>
                        ` : ''}
                    </div>
                ` : '';

                const reactionButton = `
                    <button data-action="toggle-reaction" 
                            data-post-id="${post.id}" 
                            data-reacted="${hasReacted}"
                            class="flex items-center gap-1.5 p-1 px-2 text-xs rounded-full transition-colors ${hasReacted ? 'bg-red-500 text-white hover:bg-red-600' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}">
                        <i data-lucide="heart" class="w-3.5 h-3.5 fill-current ${hasReacted ? '' : 'fill-none'}"></i>
                        <span class="font-medium">${reactionCount}</span>
                    </button>
                `;

                return `
                    <div class="group relative pl-6 pb-8 last:pb-0">
                        <div class="timeline-dot absolute -left-[5px] top-1.5 h-2.5 w-2.5 rounded-full bg-blue-500 ring-4 ring-gray-50 dark:ring-gray-950"></div>
                        
                        <div class="flex flex-col gap-1.5">
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-medium text-gray-900 dark:text-gray-200 text-xs">
                                        ${post.authorId === 'admin' ? 'Admin Post' : 'Member'}
                                        ${isAdmin ? `<span class="text-gray-400 font-mono text-[10px] ml-1 select-all" title="Author ID">${escapeHtml(post.authorId)}</span>` : ''}
                                    </span>
                                    <span class="text-xs text-gray-400">
                                        &bull; ${formatRelativeTime(post.createdAt)}
                                    </span>
                                    ${post.tag ? `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold tracking-wide uppercase ${tagColorClass}">${escapeHtml(post.tag)}</span>` : ''}
                                </div>
                                ${postControls}
                            </div>

                            ${postContentHtml}
                            
                            <div class="flex justify-end pt-1">
                                ${reactionButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function renderMedia(url) {
            const safeUrl = escapeHtml(url);
            if (isImageUrl(url)) {
                return `
                    <div class="mt-3 overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 max-w-md">
                        <img src="${safeUrl}" alt="Post image" class="w-full h-auto object-cover max-h-80" 
                             onerror="this.onerror=null; this.src='https://placehold.co/400x200/94a3b8/ffffff?text=Image+Load+Failed';">
                    </div>
                `;
            } else {
                return `
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer"
                       class="flex items-center gap-3 p-3 mt-3 rounded-lg border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors w-full max-w-sm group">
                        <div class="h-8 w-8 flex items-center justify-center rounded bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 shrink-0 group-hover:scale-110 transition-transform">
                            <i data-lucide="external-link" class="w-4 h-4" aria-label="External Link"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-xs font-medium text-blue-600 dark:text-blue-400 truncate">${safeUrl}</p>
                            <p class="text-[10px] text-gray-500 uppercase tracking-wide">External Link</p>
                        </div>
                    </a>
                `;
            }
        }
        
        // NEW: Tool Rendering functions
        function renderTools() {
            toolsLoadingMessage.classList.add('hidden');
            
            if (tools.length === 0) {
                toolsListContainer.innerHTML = `
                    <p class="col-span-full text-center text-gray-400 py-10">No downloadable tools have been added yet.</p>
                `;
                return;
            }

            toolsListContainer.innerHTML = tools.map(tool => `
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-5 flex flex-col justify-between h-full">
                    <div>
                        <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-2">${escapeHtml(tool.title)}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${escapeHtml(tool.description)}</p>
                    </div>
                    <a href="${escapeHtml(tool.link)}" target="_blank" rel="noopener noreferrer" 
                       class="mt-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-colors disabled:opacity-50">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download
                    </a>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderManagedTools() {
            if (!isAdmin) {
                managedToolsList.innerHTML = '';
                return;
            }
            
            // Render the list of tools for editing/deleting
            managedToolsList.innerHTML = `
                <h4 class="text-sm font-semibold mb-2">Available Tools (${tools.length})</h4>
                ${tools.map(tool => `
                    <div id="managed-tool-${tool.id}" class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg flex items-center justify-between">
                        <span class="text-sm font-medium truncate">${escapeHtml(tool.title)}</span>
                        <div class="flex gap-2 shrink-0">
                            <button data-action="edit-tool" data-tool-id="${tool.id}" class="text-blue-500 hover:text-blue-700 p-1 rounded transition-colors" title="Edit">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button data-action="delete-tool" data-tool-id="${tool.id}" class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
            lucide.createIcons();
        }


        // --- EVENTS ---
        
        feedContainer.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const postId = target.dataset.postId;
            const hasReacted = target.dataset.reacted === 'true';
            const currentUserId = currentUser ? currentUser.uid : null;

            if (!currentUserId) {
                 handleError("Authentication required.");
                 return;
            }
            
            const post = posts.find(p => p.id === postId);
            const isAuthor = post && post.authorId === currentUserId;
            const canEditOrDelete = isAdmin || isAuthor;

            switch(action) {
                case 'toggle-reaction':
                    toggleReaction(postId, currentUserId, hasReacted);
                    break;
                case 'edit-post':
                    if (canEditOrDelete) toggleEdit(postId, false);
                    else handleError("Admin or Post Author privileges required.");
                    break;
                case 'save-edit':
                    if (canEditOrDelete) toggleEdit(postId, true);
                    else handleError("Admin or Post Author privileges required to save.");
                    break;
                case 'delete-post':
                    if (canEditOrDelete) deletePost(postId);
                    else handleError("Admin or Post Author privileges required to delete.");
                    break;
            }
        });
        
        // NEW: Tool Admin Button Logic (Add/Save Tool)
        addToolBtn.addEventListener('click', async () => {
            const title = toolTitleInput.value.trim();
            const description = toolDescriptionInput.value.trim();
            const link = toolLinkInput.value.trim();
            
            if (!isAdmin) return handleError("Only Admin can manage tools.");

            if (!title || !description || !link) {
                return handleError("All fields are required to add/save a tool.");
            }

            addToolBtn.disabled = true;
            addToolBtn.textContent = editingToolId ? 'Saving...' : 'Adding...';

            try {
                const toolData = {
                    title,
                    description,
                    link,
                    createdAt: serverTimestamp()
                };

                if (editingToolId) {
                    // Update existing tool
                    await setDoc(doc(db, 'tools', editingToolId), toolData);
                    handleSuccess("Tool updated successfully!");
                } else {
                    // Add new tool
                    await addDoc(collection(db, 'tools'), toolData);
                    handleSuccess("New tool added successfully!");
                }
                
                // Reset form
                toolTitleInput.value = '';
                toolDescriptionInput.value = '';
                toolLinkInput.value = '';
                editingToolId = null;
                addToolBtn.textContent = 'Add New Tool';
            } catch (err) {
                if (err.code === 'permission-denied') {
                    handleError("Action blocked. Missing or insufficient permissions. Check your Firestore Security Rules for the 'tools' collection.");
                } else {
                    handleError("Failed to save tool.");
                }
                console.error(err);
            } finally {
                addToolBtn.disabled = false;
                lucide.createIcons();
            }
        });

        // The rest of the event listeners remain the same for post CRUD and tool list actions
        // ... (existing post CRUD functions and tool management event delegation)

        submitBtn.addEventListener('click', async () => {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            const link = linkInput.value.trim();
            const tag = selectedTag;

            if (!currentUser) return handleError("Not authenticated.");

            if (!content && !link && !title) {
                composerCard.classList.add('flash-red');
                setTimeout(() => composerCard.classList.remove('flash-red'), 500);
                return handleError("Please enter a title, content, or link.");
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Posting...';

            try {
                await addDoc(collection(db, COLLECTION_NAME), {
                    title,
                    content,
                    link,
                    tag,
                    authorId: isAdmin ? 'admin' : currentUser.uid, 
                    createdAt: serverTimestamp(),
                    reactions: {}
                });
                titleInput.value = '';
                contentInput.value = '';
                linkInput.value = '';
                selectedTag = 'General';
                updateTagSelection('General');
                handleSuccess("Update posted successfully!"); 
            } catch (err) {
                handleError("Failed to post. Check your Firestore Security Rules.");
                console.error(err);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Post Update</span><i data-lucide="send" class="w-3.5 h-3.5"></i>';
                lucide.createIcons();
            }
        });

        const toggleReaction = async (postId, userId, hasReacted) => {
            const docRef = doc(db, COLLECTION_NAME, postId);
            try {
                const post = posts.find(p => p.id === postId);
                if (!post) return;
                let newReactions = { ...post.reactions };
                if (hasReacted) delete newReactions[userId];
                else newReactions[userId] = true;
                await updateDoc(docRef, { reactions: newReactions });
            } catch (e) { handleError("Failed to update reaction."); }
        };

        const toggleEdit = async (id, currentlyEditing) => {
            if (!id) return; 

            if (currentlyEditing) {
                const newTitle = document.getElementById(`edit-title-${id}`).value.trim();
                const newContent = document.getElementById(`edit-content-${id}`).value.trim();
                const newLink = document.getElementById(`edit-link-${id}`).value.trim();
                const newTag = document.getElementById(`edit-tag-${id}`).value;
                const originalPost = posts.find(p => p.id === id);

                try {
                    await setDoc(doc(db, COLLECTION_NAME, id), { 
                        title: newTitle,
                        content: newContent, 
                        link: newLink,
                        tag: newTag,
                        authorId: originalPost.authorId,
                        createdAt: originalPost.createdAt,
                        reactions: originalPost.reactions
                    });
                    editingPostId = null;
                    applySearchFilter();
                    handleSuccess("Post saved successfully!"); 
                } catch (e) { handleError("Failed to save."); }
            } else {
                editingPostId = id;
                applySearchFilter();
            }
        };

        const deletePost = async (id) => {
            if (!id) return;
            if (!confirm("Are you sure you want to delete this post?")) return;
            try { 
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                handleSuccess("Post deleted."); 
            } 
            catch(e) { handleError("Delete failed. Check security rules."); }
        };
        
        pcstoolsView.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.dataset.action;
            const toolId = target.dataset.toolId;
            
            switch(action) {
                case 'edit-tool':
                    startToolEdit(toolId);
                    break;
                case 'delete-tool':
                    deleteTool(toolId);
                    break;
            }
        });

        function startToolEdit(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            editingToolId = toolId;
            toolTitleInput.value = tool.title;
            toolDescriptionInput.value = tool.description;
            toolLinkInput.value = tool.link;
            addToolBtn.textContent = 'Save Changes';
            handleSuccess(`Editing: ${tool.title}`);
        }

        async function deleteTool(toolId) {
            if (!confirm("Are you sure you want to delete this tool?")) return;
            try {
                await deleteDoc(doc(db, 'tools', toolId));
                handleSuccess("Tool deleted successfully.");
            } catch (e) {
                handleError("Failed to delete tool. Check security rules.");
                console.error(e);
            }
        }


        // --- UTILS (Shared) ---
        
        function calculateDecimalTime() {
            const hours = parseInt(hoursInput.value) || 0;
            const minutes = parseInt(minutesInput.value) || 0;
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return;
            decimalResult.textContent = (hours + (minutes / 60)).toFixed(2);
        }
        hoursInput.addEventListener('input', calculateDecimalTime);
        minutesInput.addEventListener('input', calculateDecimalTime);

        function calculatePercentage() {
            const x = parseFloat(percentX.value) || 0;
            const y = parseFloat(percentY.value) || 0;
            percentageResult.textContent = ((x / 100) * y).toFixed(2).replace(/\.00$/, '');
        }
        percentX.addEventListener('input', calculatePercentage);
        percentY.addEventListener('input', calculatePercentage);

        clearLinkBtn.addEventListener('click', () => linkInput.value = '');

        const toggleTheme = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
            lucide.createIcons();
        };

        darkModeToggle.addEventListener('click', toggleTheme);
        darkModeToggleMobile.addEventListener('click', toggleTheme);


        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollToTopBtn.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                scrollToTopBtn.classList.remove('opacity-100', 'pointer-events-auto');
            }
        };
        scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        function formatRelativeTime(ts) {
            if (!ts || !ts.seconds) return 'Just now';
            const seconds = Math.floor((new Date() - (ts.seconds * 1000)) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 30) return `${days}d ago`;
            return new Date(ts.seconds * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function handleError(msg) {
            errorMessage.textContent = msg;
            errorContainer.classList.remove('hidden');
            setTimeout(() => errorContainer.classList.add('hidden'), 5000);
        }
        
        function handleSuccess(msg) {
            successMessage.textContent = msg;
            successContainer.classList.remove('hidden');
            setTimeout(() => successContainer.classList.add('hidden'), 5000);
        }

        function escapeHtml(text) {
            if (!text) return text;
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        // --- TSC HELPER FUNCTIONS (MERGED FROM helper.html) ---

        function generateHardcodedDefaultTimePoints() {
            const originalTimeSegments = [ { start: "13:45:00", end: "15:30:00" }, { start: "13:30:00", end: "13:45:00" }, { start: "12:00:00", end: "13:30:00" }, { start: "11:00:00", end: "12:00:00" }, { start: "08:45:00", end: "11:00:00" }, { start: "08:30:00", end: "08:45:00" }, { start: "06:30:00", end: "08:30:00" } ];
            const timePointStrings = new Set();
            originalTimeSegments.forEach(entry => { timePointStrings.add(entry.start); timePointStrings.add(entry.end); });
            const sortedTimePoints = Array.from(timePointStrings).sort((a, b) => {
                 let minutesA = timeStringToMinutes(a), minutesB = timeStringToMinutes(b);
                 if (minutesA > 1000 && minutesB < 500) return -1; if (minutesB > 1000 && minutesA < 500) return 1; return minutesA - minutesB;
            });
            return sortedTimePoints.map(timeStr => timeString24hrToPointObject(timeStr));
        }

        function getDefaultSettings() {
            const today = new Date(), offset = today.getTimezoneOffset(), localToday = new Date(today.getTime() - (offset*60*1000)), formattedDate = localToday.toISOString().split('T')[0];
            return {
                techNumber: '7236', username: 'lorens.ebrado', shift: 'Day', date: formattedDate, ot: 'NO',
                categoryPair1: { main: 'DOWNTIME', sub: 'NoProject' }, timePoints: generateHardcodedDefaultTimePoints()
            };
        }

        function initializeSettings(forceReset = false) {
            if (forceReset) { localStorage.removeItem(LOCAL_STORAGE_KEY); localStorage.removeItem(SCHEDULE_TEMPLATES_KEY); }
            const storedSettings = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedSettings) {
                try {
                    const loaded = JSON.parse(storedSettings); if (loaded.timePoints && loaded.categoryPair1) { currentSettings = loaded; return; }
                } catch (e) { console.error("Failed to parse settings", e); }
            }
            currentSettings = getDefaultSettings();
        }

        // --- TSC HELPER UTILITY FUNCTIONS ---
        function formatTimeComponent(c) { return String(c).padStart(2, '0'); }
        function timeStringToMinutes(timeStr) { const [h=0, m=0] = (timeStr || "0:0").split(':').map(Number); return h * 60 + m; }
        function timeString24hrToSeconds(timeStr) { const parts = (timeStr || "0:0:0").split(':'); return (parseInt(parts[0],10) * 3600) + (parseInt(parts[1],10) * 60) + (parseInt(parts[2],10) || 0); }
        function secondsToTimeString(totalSeconds) { const h = Math.floor(totalSeconds / 3600), m = Math.floor((totalSeconds % 3600) / 60), s = totalSeconds % 60; return `${formatTimeComponent(h)}:${formatTimeComponent(m)}:${formatTimeComponent(s)}`; }
        function addMinutesToTime(timeStr, minutesToAdd) { const totalMinutes = timeStringToMinutes(timeStr) + minutesToAdd; const newHours = Math.floor(totalMinutes / 60) % 24, newMinutes = totalMinutes % 60; return `${formatTimeComponent(newHours)}:${formatTimeComponent(newMinutes)}`; }
        function convert12hrTo24hr(h12, period) { let h24 = parseInt(h12, 10); if (period.toUpperCase() === 'PM' && h24 !== 12) h24 += 12; else if (period.toUpperCase() === 'AM' && h24 === 12) h24 = 0; return h24; }
        function convert24hrTo12hr(h24, min) { const period = h24 >= 12 ? 'PM' : 'AM'; let hour12 = h24 % 12; if (hour12 === 0) hour12 = 12; return { hour: hour12, minute: parseInt(min, 10), period: period }; }
        function timeString24hrToPointObject(timeStr) { const parts = timeStr.split(':'), hour24 = parts[0], minute = parts[1], second = parts[2] || '00'; const converted = convert24hrTo12hr(parseInt(hour24, 10), parseInt(minute, 10)); return { originalReferenceTime: `${hour24}:${minute}:${second}`, currentHour: converted.hour, currentMinute: converted.minute, currentPeriod: converted.period, override: null, isInsertedTaskEndPoint: false, uniqueId: `tp-${Date.now()}-${Math.random()}` }; }
        
        // --- TSC HELPER CORE LOGIC ---
        function run(randomize = true) {
            const { timePoints } = currentSettings;
            if (!timePoints || timePoints.length <= 1) { currentDisplayedData = []; updateDisplay(); return; }
            const datesForTimePoints = new Array(timePoints.length);
            if (timePoints.length > 0) {
                let currentDate = new Date(currentSettings.date + 'T12:00:00Z'); datesForTimePoints[0] = currentDate.toISOString().slice(0, 10);
                for (let i = 1; i < timePoints.length; i++) {
                    const prevMins = convert12hrTo24hr(timePoints[i-1].currentHour, timePoints[i-1].currentPeriod) * 60 + timePoints[i-1].currentMinute;
                    const currMins = convert12hrTo24hr(timePoints[i].currentHour, timePoints[i].currentPeriod) * 60 + timePoints[i].currentMinute;
                    if (currMins < prevMins) { currentDate.setDate(currentDate.getDate() + 1); }
                    datesForTimePoints[i] = currentDate.toISOString().slice(0, 10);
                }
            }
            if (randomize || randomizedTimes.length !== timePoints.length) { randomizedTimes = timePoints.map(tp => { const h24 = convert12hrTo24hr(tp.currentHour, tp.currentPeriod); return `${formatTimeComponent(h24)}:${formatTimeComponent(tp.currentMinute)}:${formatTimeComponent(Math.floor(Math.random()*60))}`; }); }
            const newTableData = [];
            for (let i = 0; i < timePoints.length - 1; i++) {
                const startPoint = timePoints[i], nextPoint = timePoints[i+1];
                let assignedCategory, assignedOT;
                if (startPoint.override) { assignedCategory = startPoint.override; assignedOT = startPoint.override.ot || currentSettings.ot; } 
                else {
                    let startMins = convert12hrTo24hr(startPoint.currentHour, startPoint.currentPeriod) * 60 + startPoint.currentMinute;
                    let endMins = convert12hrTo24hr(nextPoint.currentHour, nextPoint.currentPeriod) * 60 + nextPoint.currentMinute;
                    if (endMins < startMins) { endMins += 24 * 60; }
                    const durationMins = endMins - startMins;
                    if (durationMins === 15 || durationMins === 60) { assignedCategory = { main: 'BREAK', sub: 'BREAK' }; assignedOT = 'NO'; } 
                    else { assignedCategory = currentSettings.categoryPair1; assignedOT = currentSettings.ot; }
                }
                const startTime24Hr = randomizedTimes[i], endTime24Hr = randomizedTimes[i + 1];
                let startTotalSecs = timeString24hrToSeconds(startTime24Hr), endTotalSecs = timeString24hrToSeconds(endTime24Hr);
                if (endTotalSecs < startTotalSecs) endTotalSecs += 24 * 3600;
                const durationSecs = endTotalSecs - startTotalSecs;
                const [startH, startM, startS] = startTime24Hr.split(':'), start12hr = convert24hrTo12hr(startH, startM);
                const [endH, endM, endS] = endTime24Hr.split(':'), end12hr = convert24hrTo12hr(endH, endM);
                newTableData.push({ ...currentSettings, date: datesForTimePoints[i], start: `${start12hr.hour}:${formatTimeComponent(start12hr.minute)}:${startS} ${start12hr.period}`, end: `${end12hr.hour}:${formatTimeComponent(end12hr.minute)}:${endS} ${end12hr.period}`, startTime24: startTime24Hr, endTime24: endTime24Hr, duration: secondsToTimeString(durationSecs), mainCategory: assignedCategory.main, subCategory: assignedCategory.sub, ot: assignedOT });
            }
            currentDisplayedData = newTableData.reverse(); updateDisplay(); checkTotalWorkHours();
        }
        function checkTotalWorkHours() {
            let totalWorkSecs = 0;
            currentDisplayedData.forEach(e => { if (e.mainCategory !== 'BREAK') { totalWorkSecs += timeString24hrToSeconds(e.duration); } });
            durationWarning.classList.toggle('hidden', totalWorkSecs <= DURATION_LIMIT_SECONDS);
            if (totalWorkSecs > DURATION_LIMIT_SECONDS) { durationWarning.textContent = `Warning: Total work hours are ${secondsToTimeString(totalWorkSecs)}, which exceeds the 07:30:00 limit.`; }
        }

        function updateDisplay() {
            timeTableBody.innerHTML = '';
            const createCell = (text) => {
                const cell = document.createElement('td');
                cell.textContent = text;
                return cell;
            };
            currentDisplayedData.forEach((entry, displayIndex) => {
                const chronoIndex = (currentSettings.timePoints.length - 2) - displayIndex;
                const endPoint = currentSettings.timePoints[chronoIndex + 1];
                const row = document.createElement('tr');
                
                row.appendChild(createCell(entry.techNumber));
                row.appendChild(createCell(entry.username));
                row.appendChild(createCell(entry.shift));
                
                const dateCell = document.createElement('td');
                if (displayIndex === currentDisplayedData.length - 1) {
                    // MODIFICATION: Add a container and icon
                    const container = document.createElement('div');
                    container.className = 'flex items-center gap-2';

                    const dateInput = document.createElement('input');
                    dateInput.type = 'text';
                    dateInput.value = entry.date;
                    dateInput.className = 'editable-date flex-grow';
                    dateInput.addEventListener('change', (e) => {
                        const newValue = e.target.value;
                        const isValidFormat = /^\d{4}-\d{2}-\d{2}$/.test(newValue);
                        const isValidDate = !isNaN(Date.parse(newValue));
                        if (isValidFormat && isValidDate) {
                            currentSettings.date = newValue;
                            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings));
                            run(false);
                            showMessageBox("Shift start date updated.");
                        } else {
                            e.target.value = entry.date;
                            showMessageBox("Invalid date. Please use YYYY-MM-DD format.", true);
                        }
                    });

                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'text-slate-500'; // Icon color
                    iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.774a2.75 2.75 0 0 0-.596.892l-1.023 3.068a.75.75 0 0 0 .963.963l3.068-1.023a2.75 2.75 0 0 0 .892-.596l4.262-4.263a1.75 1.75 0 0 0 0-2.474Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V9.5A.75.75 0 0 1 14 9.5v2.25A2.75 2.75 0 0 1 11.25 14h-6.5A2.75 2.75 0 0 1 2 11.25v-6.5A2.75 2.75 0 0 1 4.75 2H7a.75.75 0 0 1 0 1.5H4.75Z" /></svg>`;

                    container.appendChild(dateInput);
                    container.appendChild(iconSpan);
                    dateCell.appendChild(container);
                } else {
                    dateCell.textContent = entry.date;
                }
                row.appendChild(dateCell);

                row.appendChild(createCell(entry.start));
                row.appendChild(createCell(entry.end));
                row.appendChild(createCell(entry.duration));
                
                const mainCatCell = document.createElement('td'), mainCatSelect = document.createElement('select');
                mainCatSelect.innerHTML = Object.keys(categoryData).map(k => `<option value="${k}" ${k === entry.mainCategory ? 'selected' : ''}>${k}</option>`).join(''); mainCatCell.appendChild(mainCatSelect);
                const subCatCell = document.createElement('td'), subCatSelect = document.createElement('select');
                updateSubCategoryDropdown(mainCatSelect, subCatSelect, entry.subCategory, false); subCatCell.appendChild(subCatSelect);
                const otCell = document.createElement('td'), otSelect = document.createElement('select');
                otSelect.innerHTML = `<option value="NO" ${entry.ot === 'NO' ? 'selected' : ''}>NO</option><option value="YES" ${entry.ot === 'YES' ? 'selected' : ''}>YES</option>`; otCell.appendChild(otSelect);
                const actionCell = document.createElement('td');
                if (endPoint.isInsertedTaskEndPoint) { const removeBtn = document.createElement('button'); removeBtn.textContent = 'Remove'; removeBtn.className = 'button-remove'; removeBtn.onclick = () => removeTask(chronoIndex + 1); actionCell.appendChild(removeBtn); }
                row.appendChild(mainCatCell); row.appendChild(subCatCell); row.appendChild(otCell); row.appendChild(actionCell);
                timeTableBody.appendChild(row);

                mainCatSelect.onchange = () => { updateSubCategoryDropdown(mainCatSelect, subCatSelect, null, true); updateRowOverride(chronoIndex, mainCatSelect.value, subCatSelect.value, otSelect.value); };
                subCatSelect.onchange = () => updateRowOverride(chronoIndex, mainCatSelect.value, subCatSelect.value, otSelect.value);
                otSelect.onchange = () => updateRowOverride(chronoIndex, mainCatSelect.value, subCatSelect.value, otSelect.value);
            });
        }

        function copyTableDataToClipboard() {
            if (currentDisplayedData.length === 0) { showMessageBox('No data to copy.', true); return; }
            let textToCopy = currentDisplayedData.map(e => `${e.techNumber}\t${e.username}\t${e.shift}\t${e.date}\t${e.startTime24}\t${e.endTime24}\t${e.duration}\t${e.mainCategory}\t${e.subCategory}\t${e.ot}`).join('\n');
            navigator.clipboard.writeText(textToCopy).then(() => showMessageBox('Table data copied (24hr format, no headers)!'), () => showMessageBox('Failed to copy table data.', true));
        }
        function showMessageBox(message, isError = false) {
            messageBox.textContent = message; messageBox.className = 'message-box visible';
            messageBox.classList.toggle('error', isError);
            setTimeout(() => messageBox.className = 'message-box', 4000);
        }

        // --- TSC HELPER MODAL & ACTION LOGIC ---
        function updateSubCategoryDropdown(mainSelect, subSelect, selectedSub = null, isChangeEvent = false) { const subOptions = categoryData[mainSelect.value] || []; subSelect.innerHTML = subOptions.map(opt => `<option value="${opt}">${opt}</option>`).join(''); if (!isChangeEvent && selectedSub && subOptions.includes(selectedSub)) { subSelect.value = selectedSub; } else if (subOptions.length > 0) { subSelect.value = subOptions[0]; } }
        function updateRowOverride(chronoIndex, main, sub, ot) { const startPoint = currentSettings.timePoints[chronoIndex]; if (!startPoint.override) startPoint.override = {}; startPoint.override.main = main; startPoint.override.sub = sub; startPoint.override.ot = ot; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); run(false); }
        function removeTask(timePointIndexToRemove) { currentSettings.timePoints[timePointIndexToRemove - 1].override = null; currentSettings.timePoints.splice(timePointIndexToRemove, 1); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); run(true); showMessageBox("Task removed and merged."); }
        function openSettingsModal() { document.getElementById('techNumberInput').value = currentSettings.techNumber; document.getElementById('usernameInput').value = currentSettings.username; document.getElementById('shiftInput').value = currentSettings.shift; document.getElementById('dateInput').value = currentSettings.date; document.getElementById('otInput').value = currentSettings.ot; const mainCatSelect = document.getElementById('mainCatSelect'), subCatSelect = document.getElementById('subCatSelect'); mainCatSelect.innerHTML = Object.keys(categoryData).filter(k=>k!=="BREAK").map(k => `<option value="${k}">${k}</option>`).join(''); mainCatSelect.value = currentSettings.categoryPair1.main; updateSubCategoryDropdown(mainCatSelect, subCatSelect, currentSettings.categoryPair1.sub); populateScheduleDropdown(); settingsModal.style.display = 'flex'; }
        function saveSettings() { currentSettings.techNumber = document.getElementById('techNumberInput').value; currentSettings.username = document.getElementById('usernameInput').value; currentSettings.shift = document.getElementById('shiftInput').value; currentSettings.date = document.getElementById('dateInput').value; currentSettings.ot = document.getElementById('otInput').value; currentSettings.categoryPair1 = { main: document.getElementById('mainCatSelect').value, sub: document.getElementById('subCatSelect').value }; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); settingsModal.style.display = 'none'; run(true); showMessageBox('Settings saved!'); }
        
        // --- TSC HELPER SCHEDULE MANAGEMENT ---
        function getScheduleTemplates() { return JSON.parse(localStorage.getItem(SCHEDULE_TEMPLATES_KEY)) || []; }
        function saveScheduleTemplates(templates) { localStorage.setItem(SCHEDULE_TEMPLATES_KEY, JSON.stringify(templates)); }
        function populateScheduleDropdown() {
            const templates = getScheduleTemplates(); selectScheduleDropdown.innerHTML = '<option value="-1">Select to apply...</option>';
            const defaultOption = document.createElement('option'); defaultOption.value = 'default'; defaultOption.textContent = 'Default'; selectScheduleDropdown.appendChild(defaultOption);
            templates.forEach((template, index) => { const option = document.createElement('option'); option.value = index; option.textContent = template.name; selectScheduleDropdown.appendChild(option); });
        }
        function deleteSelectedSchedule() {
            const selectedValue = selectScheduleDropdown.value;
            if (selectedValue === "-1") { showMessageBox('Select a schedule to delete.', true); return; }
            if (selectedValue === "default") { showMessageBox('The Default schedule cannot be deleted.', true); return; }
            if (confirm(`Are you sure you want to delete the "${selectScheduleDropdown.options[selectScheduleDropdown.selectedIndex].text}" schedule?`)) {
                let templates = getScheduleTemplates(); templates.splice(parseInt(selectedValue, 10), 1);
                saveScheduleTemplates(templates); populateScheduleDropdown(); showMessageBox('Schedule deleted.');
            }
        }
        function saveScheduleTemplate() {
            const name = document.getElementById('scheduleTemplateNameInput').value.trim();
            if (!name) { scheduleErrorMessage.textContent = 'Please enter a name for the schedule.'; return; }
            if (name.toLowerCase() === 'default') { scheduleErrorMessage.textContent = 'Cannot use the reserved name "Default".'; return; }
            const times = { timeIn: document.getElementById('schedTimeIn').value, break1: document.getElementById('schedBreak1').value, lunch:  document.getElementById('schedLunch').value, break2: document.getElementById('schedBreak2').value, timeOut: document.getElementById('schedTimeOut').value };
            if (!times.timeIn || !times.timeOut) { scheduleErrorMessage.textContent = 'Time IN and OUT are required to save.'; return; }
            let templates = getScheduleTemplates();
            const existingIndex = templates.findIndex(t => t.name.toLowerCase() === name.toLowerCase());
            if (existingIndex > -1) { if (confirm(`A schedule named "${name}" already exists. Overwrite it?`)) { templates[existingIndex].times = times; } else { return; } } 
            else { templates.push({ name, times }); }
            saveScheduleTemplates(templates); showMessageBox(`Schedule "${name}" saved!`); populateScheduleDropdown(); scheduleModal.style.display = 'none';
        }
        function generateTimePointsFromSchedule(scheduleTimes, onError) {
            for (const key in scheduleTimes) { if (!scheduleTimes[key]) { onError(`Error: Please fill in all time fields.`); return null; } }
            const calculatedPoints = [ scheduleTimes.timeIn, scheduleTimes.break1, addMinutesToTime(scheduleTimes.break1, 15), scheduleTimes.lunch, addMinutesToTime(scheduleTimes.lunch, 60), scheduleTimes.break2, addMinutesToTime(scheduleTimes.break2, 15), scheduleTimes.timeOut ];
            const pointsInMins = calculatedPoints.map(t => timeStringToMinutes(t));
            for (let i = 1; i < pointsInMins.length; i++) { if (pointsInMins[i] < pointsInMins[i-1] && (pointsInMins[i-1] - pointsInMins[i] < 720)) { onError('Error: Times must be in chronological order.'); return null; } }
            return calculatedPoints.map(t => timeString24hrToPointObject(t));
        }
        function handleApplySchedule() {
            const scheduleTimes = { timeIn: document.getElementById('schedTimeIn').value, break1: document.getElementById('schedBreak1').value, lunch: document.getElementById('schedLunch').value, break2: document.getElementById('schedBreak2').value, timeOut: document.getElementById('schedTimeOut').value };
            const newTimePoints = generateTimePointsFromSchedule(scheduleTimes, (msg) => scheduleErrorMessage.textContent = msg);
            if (newTimePoints) { currentSettings.timePoints = newTimePoints; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); scheduleModal.style.display = 'none'; settingsModal.style.display = 'none'; run(true); showMessageBox('New schedule has been applied!'); }
        }

        // Minimized Insert Task functions
        function openInsertTaskModal() {
            const taskSegmentSelect = document.getElementById('taskSegmentSelect'); taskSegmentSelect.innerHTML = '';
            currentDisplayedData.forEach((entry, i) => { if (entry.mainCategory !== 'BREAK') { const option = document.createElement('option'); option.value = i; option.textContent = `[${entry.date}] ${entry.start} -> ${entry.end} (${entry.mainCategory})`; taskSegmentSelect.appendChild(option); } });
            if (taskSegmentSelect.options.length === 0) { showMessageBox("No non-break segments available to insert a task into.", true); return; }
            taskErrorMessage.textContent = ''; const taskMainCatSelect = document.getElementById('taskMainCatSelect'), taskSubCatSelect = document.getElementById('taskSubCatSelect');
            taskMainCatSelect.innerHTML = Object.keys(categoryData).filter(k=>k!=="BREAK").map(k => `<option value="${k}">${k}</option>`).join('');
            updateSubCategoryDropdown(taskMainCatSelect, taskSubCatSelect); insertTaskModal.style.display = 'flex';
        }
        function handleApplyTask() {
            taskErrorMessage.textContent = '';
            const chronoIndex = (currentSettings.timePoints.length - 2) - parseInt(document.getElementById('taskSegmentSelect').value, 10);
            const durationMins = parseInt(document.getElementById('taskDurationInput').value, 10);
            if (isNaN(durationMins) || durationMins <= 0) { taskErrorMessage.textContent = 'Error: Please enter a valid number of minutes.'; return; }
            const newTaskDurationSecs = durationMins * 60, startPoint = currentSettings.timePoints[chronoIndex], endPoint = currentSettings.timePoints[chronoIndex + 1];
            let startPointSecs = timeString24hrToSeconds(startPoint.originalReferenceTime), endPointSecs = timeString24hrToSeconds(endPoint.originalReferenceTime);
            if (endPointSecs < startPointSecs) endPointSecs += 24 * 3600;
            if(newTaskDurationSecs >= (endPointSecs - startPointSecs)) { taskErrorMessage.textContent = 'Error: New task duration is longer than the selected segment.'; return; }
            const newPointTotalSecs = startPointSecs + newTaskDurationSecs, newPointTimeString = secondsToTimeString(newPointTotalSecs % (24 * 3600));
            const newTimePointObject = timeString24hrToPointObject(newPointTimeString); newTimePointObject.isInsertedTaskEndPoint = true;
            const main = document.getElementById('taskMainCatSelect').value, sub = document.getElementById('taskSubCatSelect').value;
            if (!startPoint.override) startPoint.override = {}; startPoint.override.main = main; startPoint.override.sub = sub; startPoint.override.ot = currentSettings.ot;
            currentSettings.timePoints.splice(chronoIndex + 1, 0, newTimePointObject);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); run(true); showMessageBox('New task inserted successfully!');
            document.getElementById('taskDurationInput').value = ''; insertTaskModal.style.display = 'none';
        }

        // --- TSC HELPER EVENT LISTENERS (Merged into main script flow) ---
        randomizeButton.addEventListener('click', () => run(true));
        copyButton.addEventListener('click', copyTableDataToClipboard);
        settingsButton.addEventListener('click', openSettingsModal);
        insertTaskButton.addEventListener('click', openInsertTaskModal);
        clearDataButton.addEventListener('click', () => {
             if (confirm("Are you sure you want to clear all data? This action cannot be undone and will remove all saved settings and schedule templates.")) {
                initializeSettings(true); run(true); showMessageBox("All data has been cleared.");
            }
        });
        
        saveSettingsButton.addEventListener('click', saveSettings);
        cancelSettingsButton.addEventListener('click', () => settingsModal.style.display = 'none');
        closeSettingsModalButton.addEventListener('click', () => settingsModal.style.display = 'none');
        resetSettingsButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all data? This action cannot be undone and will remove all saved settings and schedule templates.")) {
                initializeSettings(true); settingsModal.style.display = 'none'; run(true);
                showMessageBox("All data has been cleared.");
            }
        });
        selectScheduleDropdown.addEventListener('change', () => {
            const selectedValue = selectScheduleDropdown.value;
            if (selectedValue === "-1") return;
            if (selectedValue === 'default') {
                currentSettings.timePoints = generateHardcodedDefaultTimePoints();
                run(true); showMessageBox(`Applied schedule: Default`);
            } else {
                const templates = getScheduleTemplates(), selectedTemplate = templates[parseInt(selectedValue, 10)];
                const newTimePoints = generateTimePointsFromSchedule(selectedTemplate.times, (msg) => showMessageBox(msg, true));
                if (newTimePoints) { currentSettings.timePoints = newTimePoints; run(true); showMessageBox(`Applied schedule: ${selectedTemplate.name}`); }
            }
            selectScheduleDropdown.value = "-1";
        });
        deleteScheduleButton.addEventListener('click', deleteSelectedSchedule);

        generateScheduleButton.addEventListener('click', () => { 
            scheduleErrorMessage.textContent = ''; document.getElementById('scheduleTemplateNameInput').value = '';
            ['schedTimeIn', 'schedBreak1', 'schedLunch', 'schedBreak2', 'schedTimeOut'].forEach(id => document.getElementById(id).value = '');
            scheduleModal.style.display = 'flex'; 
        });
        applyScheduleButton.addEventListener('click', handleApplySchedule);
        cancelScheduleButton.addEventListener('click', () => scheduleModal.style.display = 'none');
        saveScheduleTemplateButton.addEventListener('click', saveScheduleTemplate);
        
        document.getElementById('taskMainCatSelect').addEventListener('change', () => updateSubCategoryDropdown(document.getElementById('taskMainCatSelect'), document.getElementById('taskSubCatSelect')));
        applyTaskButton.addEventListener('click', handleApplyTask);
        cancelTaskButton.addEventListener('click', () => insertTaskModal.style.display = 'none');
        closeTaskModalButton.addEventListener('click', () => insertTaskModal.style.display = 'none');

        
        // Final initialization calls
        calculateDecimalTime(); 
        calculatePercentage();
        lucide.createIcons();

        // TSC Helper initialization
        initializeSettings(); 
        run(true);
    </script>
</body>
</html>
